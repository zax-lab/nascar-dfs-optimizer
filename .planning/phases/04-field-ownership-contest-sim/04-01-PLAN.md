---
phase: 04-field-ownership-contest-sim
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/app/ownership/__init__.py
  - apps/backend/app/ownership/historical.py
  - apps/backend/app/ownership/projections.py
  - apps/backend/app/ownership/projections_fetcher.py
  - apps/backend/app/ownership/salary_model.py
  - apps/backend/app/ownership/features.py
autonomous: true

must_haves:
  truths:
    - "Historical ownership model computes track-archetype specific baseline ownership"
    - "Projections-based model estimates ownership from projected points vs salary ratio"
    - "Salary-skill regression model learns relationship between salary/skill and ownership"
    - "Feature engineering pipeline creates ownership prediction features"
    - "All models handle missing data gracefully (graceful degradation)"
  artifacts:
    - path: "apps/backend/app/ownership/historical.py"
      provides: "HistoricalOwnershipEstimator class"
      exports: ["HistoricalOwnershipEstimator"]
      min_lines: 80
    - path: "apps/backend/app/ownership/projections.py"
      provides: "ProjectionOwnershipEstimator class"
      exports: ["ProjectionOwnershipEstimator"]
      min_lines: 80
    - path: "apps/backend/app/ownership/projections_fetcher.py"
      provides: "ProjectionsFetcher for external projection sources"
      exports: ["ProjectionsFetcher"]
      min_lines: 60
    - path: "apps/backend/app/ownership/salary_model.py"
      provides: "SalarySkillRegressionEstimator class"
      exports: ["SalarySkillRegressionEstimator"]
      min_lines: 100
    - path: "apps/backend/app/ownership/features.py"
      provides: "OwnershipFeatures feature engineering"
      exports: ["create_ownership_features", "add_track_archetype_features"]
      min_lines: 150
  key_links:
    - from: "apps/backend/app/ownership/historical.py"
      to: "apps/backend/app/models.py"
      via: "Driver model"
      pattern: "from.*models import.*Driver"
    - from: "apps/backend/app/ownership/features.py"
      to: "apps/backend/app/ontology.py"
      via: "Driver skill properties"
      pattern: "from.*ontology import.*get_driver_skill"
---

<objective>
Build individual ownership estimation models that will be combined into an ensemble. This creates the base estimators for historical ownership, projections-based ownership, and salary-skill regression. Each model follows scikit-learn's fit/predict interface for easy ensemble composition.

Purpose: Provide multiple independent ownership signals that capture different aspects of DFS ownership behavior (historical patterns, value-based projections, salary-skill relationships)
Output: Three ownership estimator classes with fit/predict interface, plus feature engineering utilities
</objective>

<execution_context>
@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-field-ownership-contest-sim/04-CONTEXT.md
@.planning/phases/04-field-ownership-contest-sim/04-RESEARCH.md
@apps/backend/app/models.py
@apps/backend/app/ontology.py

# Reference existing optimization infrastructure
@apps/backend/app/optimizer.py
@apps/backend/app/portfolio_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ownership module with historical estimator</name>
  <files>apps/backend/app/ownership/__init__.py, apps/backend/app/ownership/historical.py</files>
  <action>
Create ownership module and HistoricalOwnershipEstimator:

**File: apps/backend/app/ownership/__init__.py**
- Export all ownership estimators
- Add module docstring explaining ownership estimation approach

**File: apps/backend/app/ownership/historical.py**
- Create HistoricalOwnershipEstimator class with fit(X, y) and predict(X) methods
- fit() should:
  - Accept X with columns: driver_id, track_archetype, race_date
  - Accept y with ownership percentages (0-100)
  - Store historical mean ownership by (driver_id, track_archetype) pairs
  - Handle missing track_archetype with overall mean fallback
- predict() should:
  - Look up historical ownership for driver-track combination
  - Return overall mean if driver not seen before
  - Return track-specific mean if driver seen but not at this track
- Use pandas groupby for efficient aggregation
- Add logging for diagnostics (number of drivers stored, coverage by track type)
- Include type hints for all methods

DO NOT:
- Don't use scikit-learn yet (that's in ensemble plan)
- Don't handle recent form yet (that's a separate estimator)
- Don't add uncertainty quantification yet (that's in ensemble plan)

Reference RESEARCH.md section "Pattern 1: Hybrid Ensemble Ownership Estimation" for HistoricalOwnershipEstimator implementation.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.historical import HistoricalOwnershipEstimator
import pandas as pd
import numpy as np

# Create sample data
X = pd.DataFrame({
    'driver_id': [1, 1, 2, 2, 3],
    'track_archetype': ['superspeedway', 'superspeedway', 'superspeedway', 'short_track', 'superspeedway'],
    'race_date': pd.date_range('2024-01-01', periods=5)
})
y = np.array([25.0, 23.0, 15.0, 8.0, 5.0])

# Test fit and predict
est = HistoricalOwnershipEstimator()
est.fit(X, y)
predictions = est.predict(X)

print('Historical estimator test passed')
print(f'Predictions shape: {predictions.shape}')
print(f'Sample predictions: {predictions[:3]}')
"
```
  </verify>
  <done>
HistoricalOwnershipEstimator created with:
- fit() stores historical ownership by driver-track combinations
- predict() returns historical ownership with fallback to mean
- Handles unseen drivers and track types gracefully
- Logging for diagnostics
  </done>
</task>

<task type="auto">
  <name>Task 2: Create projections-based ownership estimator</name>
  <files>apps/backend/app/ownership/projections.py, apps/backend/app/ownership/projections_fetcher.py</files>
  <action>
Create ProjectionOwnershipEstimator with external projections integration:

**File: apps/backend/app/ownership/projections.py**
- Create ProjectionOwnershipEstimator class with fit/predict interface
- fit() should:
  - Accept X with columns: projected_points, salary
  - Accept y with ownership percentages
  - Compute value_score = projected_points / salary
  - Fit linear regression: ownership ~ value_score
  - Store model coefficients for interpretation
  - Handle zero/negative salary with filtering
- predict() should:
  - Compute value_score from projected_points and salary
  - Apply learned linear relationship
  - Clip predictions to [0, 100] range
  - Return ownership predictions
- Add property value_score_slope_ for interpretation
- Use scikit-learn LinearRegression (already installed via Phase 3)
- Include logging for regression quality (R² score)

**File: apps/backend/app/ownership/projections_fetcher.py**
- Create ProjectionsFetcher class for external API integration
- __init__(projection_source: str = 'manual'):
  - projection_source: 'manual', 'fantasypros', 'dfs_sites'
  - For 'manual': projections provided via API input
  - For 'fantasypros': placeholder for future FantasyPros API integration
  - For 'dfs_sites': placeholder for future DraftKings/FanDuel integration
- fetch_projections(driver_ids: List[int], race_id: int) -> Dict[int, float]:
  - For 'manual': return empty dict (projections provided externally)
  - For API sources: log warning "API integration not yet implemented, use manual mode"
  - Return dict mapping driver_id -> projected_points
- Add method validate_projections(projections: Dict[int, float]) -> bool:
  - Check all projections are positive
  - Check projections are reasonable (0-100 range)
  - Return True if valid

DO NOT:
- Don't add non-linear transformations yet (keep it simple for ensemble)
- Don't implement actual API calls yet (manual/external mode only)

Reference RESEARCH.md ProjectionOwnershipEstimator example for implementation pattern.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.projections import ProjectionOwnershipEstimator
from apps.backend.app.ownership.projections_fetcher import ProjectionsFetcher
import pandas as pd
import numpy as np

# Create sample data
X = pd.DataFrame({
    'projected_points': [50, 45, 40, 35, 30],
    'salary': [10000, 9000, 8000, 7000, 6000]
})
y = np.array([25.0, 20.0, 15.0, 10.0, 5.0])

# Test fit and predict
est = ProjectionOwnershipEstimator()
est.fit(X, y)
predictions = est.predict(X)

print('Projections estimator test passed')
print(f'Value score slope: {est.value_score_slope_:.4f}')
print(f'Sample predictions: {predictions[:3]}')

# Test projections fetcher
fetcher = ProjectionsFetcher(projection_source='manual')
projections = fetcher.fetch_projections([1, 2, 3], race_id=100)
print(f'Fetched projections (manual mode): {projections}')
print('Projections fetcher test passed')
"
```
  </verify>
  <done>
ProjectionOwnershipEstimator created with:
- fit() learns linear relationship between value_score and ownership
- predict() applies learned model to new projections
- Interpretable slope parameter
- R² logging for regression quality
ProjectionsFetcher created with:
- Manual mode for external projections via API
- Placeholder structure for future API integrations
- Projections validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create salary-skill regression estimator</name>
  <files>apps/backend/app/ownership/salary_model.py</files>
  <action>
Create SalarySkillRegressionEstimator:

**File: apps/backend/app/ownership/salary_model.py**
- Create SalarySkillRegressionEstimator class with fit/predict interface
- fit() should:
  - Accept X with columns: salary, skill (from ontology), recent_avg_finish
  - Accept y with ownership percentages
  - Use scikit-learn RandomForestRegressor for non-linear relationships
  - Handle missing skill with mean imputation
  - Store feature importance for interpretation
- predict() should:
  - Apply trained RandomForest to new data
  - Clip predictions to [0, 100] range
  - Return ownership predictions
- Use scikit-learn RandomForestRegressor (already installed)
- Add feature_importances_ property for interpretation
- Include logging for feature importance ranking

DO NOT:
- Don't tune hyperparameters yet (use defaults)
- Don't add cross-validation yet (that's in ensemble plan)

Reference RESEARCH.md for salary-skill regression pattern and use RandomForest from scikit-learn.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.salary_model import SalarySkillRegressionEstimator
import pandas as pd
import numpy as np

# Create sample data
X = pd.DataFrame({
    'salary': [10000, 9000, 8000, 7000, 6000],
    'skill': [0.9, 0.8, 0.7, 0.6, 0.5],
    'recent_avg_finish': [5.0, 10.0, 15.0, 20.0, 25.0]
})
y = np.array([25.0, 20.0, 15.0, 10.0, 5.0])

# Test fit and predict
est = SalarySkillRegressionEstimator()
est.fit(X, y)
predictions = est.predict(X)

print('Salary-skill estimator test passed')
print(f'Feature importance: {est.feature_importances_}')
print(f'Sample predictions: {predictions[:3]}')
"
```
  </verify>
  <done>
SalarySkillRegressionEstimator created with:
- fit() trains RandomForest on salary, skill, recent form
- predict() applies model to new data
- Feature importance for interpretation
- Handles missing skill with imputation
  </done>
</task>

<task type="auto">
  <name>Task 4: Create feature engineering utilities</name>
  <files>apps/backend/app/ownership/features.py</files>
  <action>
Create ownership feature engineering utilities:

**File: apps/backend/app/ownership/features.py**
- Function create_ownership_features(driver_data, race_data):
  - Input: driver_data (DataFrame with driver_id, salary, projected_points, skill)
  - Input: race_data (race_id, track_archetype, race_date)
  - Output: Feature matrix X with columns:
    - driver_id (categorical)
    - salary (continuous)
    - projected_points (continuous)
    - skill (continuous, from ontology)
    - value_score = projected_points / salary
    - track_archetype (one-hot encoded: superspeedway, intermediate, short_track, road_course)
  - Handle missing projected_points with salary-based imputation
  - Handle missing skill with 0.5 (neutral)
  - Return pandas DataFrame

- Function add_track_archetype_features(X, track_archetype):
  - Add one-hot encoded track archetype columns
  - Handle unknown archetypes with 'intermediate' default
  - Return X with added columns

- Function add_recent_form_features(X, historical_finishes):
  - Compute rolling average finish over last N races (default 5)
  - Add recent_avg_finish, recent_std_finish columns
  - Handle drivers with <3 races with overall mean
  - Return X with added columns

Use pandas for feature creation, scikit-learn OneHotEncoder for categorical encoding.
Add logging for feature creation diagnostics.

Reference RESEARCH.md section on feature engineering for ownership prediction.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.features import create_ownership_features, add_track_archetype_features
import pandas as pd

# Create sample data
driver_data = pd.DataFrame({
    'driver_id': [1, 2, 3],
    'salary': [10000, 9000, 8000],
    'projected_points': [50, 45, 40],
    'skill': [0.9, 0.8, 0.7]
})
race_data = pd.DataFrame({
    'race_id': [1],
    'track_archetype': ['superspeedway']
})

# Test feature creation
X = create_ownership_features(driver_data, race_data)
print('Features created:')
print(X.columns.tolist())
print(f'Feature matrix shape: {X.shape}')
print('Feature engineering test passed')
"
```
  </verify>
  <done>
Feature engineering utilities created with:
- create_ownership_features() builds feature matrix from driver/race data
- add_track_archetype_features() one-hot encodes track type
- add_recent_form_features() computes rolling finish statistics
- Handles missing data gracefully
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Module structure**: All ownership estimators importable from apps.backend.app.ownership
2. **Estimator interface**: All estimators have fit(X, y) and predict(X) methods
3. **Historical estimator**: Handles unseen drivers/tracks with fallback to mean
4. **Projections estimator**: Learns linear relationship between value_score and ownership
5. **Salary-skill estimator**: Uses RandomForest with feature importance
6. **Feature engineering**: Creates feature matrix with one-hot encoding and rolling statistics

Run verification:
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership import (
    HistoricalOwnershipEstimator,
    ProjectionOwnershipEstimator,
    SalarySkillRegressionEstimator,
    create_ownership_features
)
print('All ownership estimators imported successfully')
"
```
</verification>

<success_criteria>
1. All three estimators (historical, projections, salary-skill) implement fit/predict interface
2. Feature engineering utilities create feature matrices with one-hot encoding
3. Each estimator handles missing data gracefully
4. Unit tests pass for all estimators
5. Module is importable without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-field-ownership-contest-sim/04-01-SUMMARY.md`
</output>
