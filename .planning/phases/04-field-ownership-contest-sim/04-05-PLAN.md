---
phase: 04-field-ownership-contest-sim
plan: 05
type: execute
wave: 3
depends_on: [04-01, 04-02, 04-04]
files_modified:
  - apps/backend/app/optimizer/leverage_aware.py
  - apps/backend/app/portfolio_generator.py
autonomous: true

must_haves:
  truths:
    - "Leverage-aware optimizer extends existing NASCAROptimizer with ownership penalties"
    - "Optimizer generates lineups with low-ownership drivers to maximize leverage"
    - "Ownership constraints enforce max total ownership and minimum low-ownership drivers"
    - "Portfolio generator extends for regime-aware allocation across scenarios"
    - "Leverage metrics calculated for each lineup (avg ownership, max ownership, leverage score)"
  artifacts:
    - path: "apps/backend/app/optimizer/leverage_aware.py"
      provides: "LeverageAwareOptimizer class"
      exports: ["LeverageAwareOptimizer"]
      min_lines: 250
  key_links:
    - from: "apps/backend/app/optimizer/leverage_aware.py"
      to: "apps/backend/app/optimizer.py"
      via: "NASCAROptimizer base class"
      pattern: "from.*optimizer import NASCAROptimizer"
    - from: "apps/backend/app/optimizer/leverage_aware.py"
      to: "apps/backend/app/ownership/ensemble.py"
      via: "HybridOwnershipEstimator for ownership estimates"
      pattern: "from.*ownership.ensemble import HybridOwnershipEstimator"
    - from: "apps/backend/app/portfolio_generator.py"
      to: "apps/backend/app/optimizer/leverage_aware.py"
      via: "Leverage-aware optimization integration"
      pattern: "from.*optimizer.leverage_aware import LeverageAwareOptimizer"
---

<objective>
Extend the existing optimizer with leverage-aware optimization that incorporates ownership estimates. This generates lineups with low-ownership drivers to maximize tournament leverage while maintaining CVaR optimization.

Purpose: Generate ownership-aware lineups that maximize leverage (differentiation from field) while preserving tail optimization
Output: LeverageAwareOptimizer that extends NASCAROptimizer with ownership penalties and constraints
</objective>

<execution_context>
@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-field-ownership-contest-sim/04-CONTEXT.md
@.planning/phases/04-field-ownership-contest-sim/04-RESEARCH.md

# Reference existing optimizer
@apps/backend/app/optimizer.py

# Reference existing portfolio generator
@apps/backend/app/portfolio_generator.py

# Reference ownership estimation from Plans 01-02
@apps/backend/app/ownership/ensemble.py

# Reference existing tail objectives
@apps/backend/app/tail_objectives.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create leverage-aware optimizer</name>
  <files>apps/backend/app/optimizer/leverage_aware.py</files>
  <action>
Create LeverageAwareOptimizer that extends NASCAROptimizer:

**File: apps/backend/app/optimizer/leverage_aware.py**

Import existing optimizer and ownership estimator:
- from apps.backend.app.optimizer import NASCAROptimizer
- from apps.backend.app.ownership.ensemble import HybridOwnershipEstimator

Create LeverageAwareOptimizer class:
- __init__(
    base_optimizer: NASCAROptimizer,
    ownership: np.ndarray,
    leverage_penalty: float = 0.5,
    max_ownership_per_driver: float = 0.3,
    min_low_ownership_drivers: int = 2,
    max_total_ownership: float = 3.0
  ):
  - base_optimizer: Existing NASCAROptimizer instance
  - ownership: Array of ownership percentages for each driver (0-100)
  - leverage_penalty: Weight for ownership penalty in objective (0-1)
  - max_ownership_per_driver: Max ownership % for any single driver (default 30%)
  - min_low_ownership_drivers: Minimum number of drivers with <10% ownership
  - max_total_ownership: Max sum of ownership percentages in lineup (default 300%)
  - Store ownership array for leverage calculations

- optimize_lineup_with_leverage(
    race_id: int,
    n_lineups: int = 10,
    exclude_drivers: List[int] = None
  ) -> List[Dict[str, Any]]:
  - Generate n_lineups ownership-aware lineups
  - For each lineup:
    - Start with base_optimizer optimization
    - Add ownership penalty to objective: maximize points - leverage_penalty * sum(ownership^2)
    - Enforce max_ownership_per_driver constraint
    - Enforce min_low_ownership_drivers constraint
    - Enforce max_total_ownership constraint
    - Calculate leverage metrics (avg ownership, max ownership, leverage score)
    - Store lineup with metrics
  - Exclude drivers from subsequent lineups
  - Return list of lineups with leverage metrics

- _add_ownership_constraints(problem, driver_vars):
  - Add ownership constraint: sum(ownership[i] * driver_vars[i]) <= max_total_ownership
  - Add per-driver max ownership constraint: ownership[i] * driver_vars[i] <= max_ownership_per_driver
  - Add low-ownership driver constraint: sum(driver_vars[i] for i where ownership[i] < 10) >= min_low_ownership_drivers
  - Return problem with added constraints

- _calculate_leverage_metrics(selected_drivers: List[Dict]) -> Dict[str, Any]:
  - Get lineup metrics from base_optimizer._calculate_lineup_metrics()
  - Add leverage-specific metrics:
    - avg_ownership: mean(ownership[driver_ids])
    - max_ownership: max(ownership[driver_ids])
    - total_ownership: sum(ownership[driver_ids])
    - leverage_score: total_projected_points - leverage_penalty * mean(ownership^2) / 100
  - Return extended metrics dict

DO NOT:
- Don't modify base_optimizer behavior (extend, don't modify)
- Don't add regime-aware allocation yet (that's in portfolio generator update)

Reference RESEARCH.md section "Leverage-Aware Optimization" for complete implementation.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.optimizer.leverage_aware import LeverageAwareOptimizer
from apps.backend.app.optimizer import NASCAROptimizer
import numpy as np

# Create sample ownership
ownership = np.array([25.3, 18.7, 12.4, 8.9, 6.2, 5.1, 4.3, 3.8, 3.2, 2.9, 2.5, 2.1])

# Note: This test will fail without database setup, but we can test the structure
try:
    # Test optimizer creation (will fail without DB)
    base_optimizer = NASCAROptimizer(None, salary_cap=50000, n_drivers=6)
    leverage_optimizer = LeverageAwareOptimizer(
        base_optimizer,
        ownership,
        leverage_penalty=0.5,
        max_ownership_per_driver=0.3
    )
    print('Leverage optimizer created successfully')
    print(f'Leverage penalty: {leverage_optimizer.leverage_penalty}')
    print(f'Max ownership per driver: {leverage_optimizer.max_ownership_per_driver}%')
except Exception as e:
    print(f'Expected error (no DB): {e}')
    print('Leverage optimizer structure test passed')
"
```
  </verify>
  <done>
LeverageAwareOptimizer created with:
- Extends NASCAROptimizer with ownership penalties
- Adds ownership constraints (max per driver, min low-ownership drivers, max total)
- Calculates leverage metrics (avg ownership, max ownership, leverage score)
- Generates lineups with ownership-aware optimization
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend portfolio generator for regime-aware allocation</name>
  <files>apps/backend/app/portfolio_generator.py</files>
  <action>
Extend existing portfolio_generator.py with regime-aware allocation:

**Add to portfolio_generator.py:**

Import leverage-aware optimizer:
- from apps.backend.app.optimizer.leverage_aware import LeverageAwareOptimizer

Extend PortfolioGenerator class (or add function if class):

Add method generate_regime_aware_portfolio(
  scenario_regimes: Dict[str, np.ndarray],
  ownership: np.ndarray,
  n_lineups_per_regime: int = 5,
  leverage_penalty: float = 0.5
) -> Dict[str, List[Dict]]:
  - scenario_regimes: Dict mapping regime name to scenario driver scores
    - e.g., {'dominator': scenarios_dominator, 'chaos': scenarios_chaos, 'fuel_mileage': scenarios_fuel}
  - ownership: Array of ownership percentages
  - For each regime:
    - Create LeverageAwareOptimizer with regime-specific scenarios
    - Generate n_lineups_per_regime leverage-aware lineups
    - Store lineups by regime
  - Return dict with regime-keyed lineups
  - Add regime allocation statistics

Add method optimize_portfolio_with_ownership(
  n_lineups: int,
  ownership: np.ndarray,
  leverage_penalty: float = 0.5,
  use_regime_allocation: bool = False
) -> List[Dict]:
  - Extend existing optimize_portfolio() method
  - If use_regime_allocation: call generate_regime_aware_portfolio()
  - Else: use LeverageAwareOptimizer for single optimization
  - Add ownership metrics to portfolio output
  - Return portfolio lineups with ownership info

Add function classify_scenario_regime(scenario_outcomes: np.ndarray) -> str:
  - Classify scenario as 'dominator', 'chaos', or 'fuel_mileage'
  - Dominator: high laps_led variance (top 20% dominate)
  - Chaos: high incident rate, low laps_led variance
  - Fuel_mileage: low caution count, low green-flag pass rate
  - Return regime label

Add function allocate_lineups_by_regime(n_lineups: int, regime_weights: Dict[str, float]) -> Dict[str, int]:
  - Allocate lineups across regimes based on weights
  - e.g., {'dominator': 0.4, 'chaos': 0.4, 'fuel_mileage': 0.2} -> {40, 40, 20} lineups
  - Return dict with lineup counts per regime

DO NOT:
- Don't modify existing portfolio generation logic (extend with new methods)
- Don't add dynamic regime weight learning yet (use static weights)

Reference RESEARCH.md section "Regime-Aware Portfolios" for implementation details.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.portfolio_generator import (
    generate_regime_aware_portfolio,
    classify_scenario_regime,
    allocate_lineups_by_regime
)
import numpy as np

# Test regime classification
scenario_dominator = np.random.gamma(10, 2, size=(10, 12))  # High variance
scenario_chaos = np.random.gamma(5, 5, size=(10, 12))  # High incidents
regime = classify_scenario_regime(scenario_dominator)
print(f'Classified as: {regime}')

# Test allocation
allocation = allocate_lineups_by_regime(100, {'dominator': 0.4, 'chaos': 0.4, 'fuel_mileage': 0.2})
print(f'Allocation: {allocation}')

print('Portfolio generator extension test passed')
"
```
  </verify>
  <done>
Portfolio generator extended with:
- generate_regime_aware_portfolio() allocates lineups across race-flow regimes
- classify_scenario_regime() labels scenarios as dominator/chaos/fuel_mileage
- allocate_lineups_by_regime() distributes lineups by regime weights
- optimize_portfolio_with_ownership() adds ownership metrics
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Leverage optimizer**: Extends NASCAROptimizer with ownership penalties
2. **Ownership constraints**: Max per driver, min low-ownership drivers, max total enforced
3. **Leverage metrics**: Avg ownership, max ownership, leverage score calculated
4. **Regime allocation**: Portfolio generator allocates lineups across regimes
5. **Integration**: Leverage-aware optimization integrates with existing optimizer

Run verification:
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.optimizer.leverage_aware import LeverageAwareOptimizer
from apps.backend.app.portfolio_generator import allocate_lineups_by_regime
import numpy as np

# Quick test
ownership = np.array([25, 20, 15, 10, 8, 6, 5, 4, 3, 2, 1, 1])
allocation = allocate_lineups_by_regime(100, {'dominator': 0.5, 'chaos': 0.3, 'fuel_mileage': 0.2})
print(f'Regime allocation: {allocation}')
print('Leverage-aware optimization verification passed')
"
```
</verification>

<success_criteria>
1. LeverageAwareOptimizer extends NASCAROptimizer without modifying base class
2. Ownership constraints added to PuLP optimization problem
3. Leverage metrics calculated for each lineup
4. Portfolio generator supports regime-aware allocation
5. All components integrate correctly
6. Unit tests pass for all components
</success_criteria>

<output>
After completion, create `.planning/phases/04-field-ownership-contest-sim/04-05-SUMMARY.md`
</output>
