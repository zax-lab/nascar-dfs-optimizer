---
phase: 04-field-ownership-contest-sim
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - apps/backend/app/ownership/recent_form.py
  - apps/backend/app/ownership/ensemble.py
  - apps/backend/app/ownership/models.py
autonomous: true

must_haves:
  truths:
    - "Recent form estimator calculates rolling ownership from last N races"
    - "Hybrid ensemble combines multiple estimators with configurable weights"
    - "Ensemble supports both voting (simple average) and stacking (meta-learner)"
    - "Ensemble provides uncertainty bounds via bootstrapping"
    - "Ownership Pydantic models validate input/output data"
  artifacts:
    - path: "apps/backend/app/ownership/recent_form.py"
      provides: "RecentFormEstimator class"
      exports: ["RecentFormEstimator"]
      min_lines: 100
    - path: "apps/backend/app/ownership/ensemble.py"
      provides: "HybridOwnershipEstimator ensemble combiner"
      exports: ["HybridOwnershipEstimator"]
      min_lines: 200
    - path: "apps/backend/app/ownership/models.py"
      provides: "Pydantic models for ownership data"
      exports: ["OwnershipRequest", "OwnershipResponse", "OwnershipPrediction"]
      min_lines: 80
  key_links:
    - from: "apps/backend/app/ownership/ensemble.py"
      to: "apps/backend/app/ownership/historical.py"
      via: "HistoricalOwnershipEstimator import"
      pattern: "from.*historical import HistoricalOwnershipEstimator"
    - from: "apps/backend/app/ownership/ensemble.py"
      to: "apps/backend/app/ownership/projections.py"
      via: "ProjectionOwnershipEstimator import"
      pattern: "from.*projections import ProjectionOwnershipEstimator"
    - from: "apps/backend/app/ownership/ensemble.py"
      to: "apps/backend/app/ownership/salary_model.py"
      via: "SalarySkillRegressionEstimator import"
      pattern: "from.*salary_model import SalarySkillRegressionEstimator"
    - from: "apps/backend/app/ownership/ensemble.py"
      to: "apps/backend/app/ownership/recent_form.py"
      via: "RecentFormEstimator import"
      pattern: "from.*recent_form import RecentFormEstimator"
    - from: "apps/backend/app/ownership/ensemble.py"
      to: "sklearn.ensemble"
      via: "VotingRegressor with weights parameter"
      pattern: "VotingRegressor.*estimators.*weights"
    - from: "apps/backend/app/ownership/ensemble.py"
      to: "apps/backend/app/ownership/ensemble.py"
      via: "HybridOwnershipEstimator.fit() calls base estimators"
      pattern: "def fit.*:.*for.*estimator.*in.*base_estimators"
---

<objective>
Build the recent form estimator and hybrid ensemble that combines all ownership signals. This completes the ownership estimation pipeline with track-archetype awareness, recent form consideration, and uncertainty quantification.

Purpose: Combine multiple ownership signals into a single robust estimate with configurable ensemble methods (voting or stacking)
Output: HybridOwnershipEstimator with uncertainty bounds, RecentFormEstimator, and Pydantic validation models
</objective>

<execution_context>
@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-field-ownership-contest-sim/04-CONTEXT.md
@.planning/phases/04-field-ownership-contest-sim/04-RESEARCH.md

# Reference individual estimators from Plan 01
@apps/backend/app/ownership/historical.py
@apps/backend/app/ownership/projections.py
@apps/backend/app/ownership/salary_model.py
@apps/backend/app/ownership/features.py

# Reference existing Pydantic models
@apps/backend/app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create recent form estimator</name>
  <files>apps/backend/app/ownership/recent_form.py</files>
  <action>
Create RecentFormEstimator for rolling ownership calculations:

**File: apps/backend/app/ownership/recent_form.py**
- Create RecentFormEstimator class with fit/predict interface
- __init__(n_recent_races=5, decay='exponential', decay_rate=0.9):
  - n_recent_races: Number of recent races to consider
  - decay: 'exponential' or 'linear' or 'none'
  - decay_rate: For exponential decay (higher = less decay)
- fit() should:
  - Accept X with columns: driver_id, race_date, track_archetype
  - Accept y with ownership percentages
  - Group by driver_id and sort by race_date descending
  - Compute weighted average ownership over last N races
  - Store recent ownership by driver_id
  - Handle drivers with <N races using all available data
- predict() should:
  - Look up recent ownership for each driver
  - Return overall mean if driver not seen before
  - Apply decay weights based on recency
- Use pandas groupby and rolling operations
- Add logging for coverage statistics

DO NOT:
- Don't handle track-archetype specific recent form yet (keep it simple)
- Don't add season-long averaging yet (that's in historical estimator)

Reference RESEARCH.md for recent form calculation patterns.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.recent_form import RecentFormEstimator
import pandas as pd
import numpy as np

# Create sample data with multiple races per driver
X = pd.DataFrame({
    'driver_id': [1, 1, 1, 2, 2, 2],
    'race_date': pd.to_datetime(['2024-01-01', '2024-01-15', '2024-02-01'] * 2),
    'track_archetype': ['superspeedway'] * 6
})
y = np.array([25.0, 23.0, 20.0, 15.0, 13.0, 10.0])

# Test fit and predict
est = RecentFormEstimator(n_recent_races=3, decay='exponential')
est.fit(X, y)
predictions = est.predict(X)

print('Recent form estimator test passed')
print(f'Predictions shape: {predictions.shape}')
print(f'Sample predictions: {predictions[:3]}')
"
```
  </verify>
  <done>
RecentFormEstimator created with:
- fit() computes weighted average ownership over recent races
- predict() returns recent ownership with fallback to mean
- Supports exponential, linear, or no decay
- Coverage statistics logging
  </done>
</task>

<task type="auto">
  <name>Task 2: Create hybrid ensemble estimator</name>
  <files>apps/backend/app/ownership/ensemble.py</files>
  <action>
Create HybridOwnershipEstimator that combines all base estimators:

**File: apps/backend/app/ownership/ensemble.py**
- Import HistoricalOwnershipEstimator, ProjectionOwnershipEstimator, SalarySkillRegressionEstimator, RecentFormEstimator
- Create HybridOwnershipEstimator class:
  - __init__(track_archetype='intermediate', n_recent_races=5, ensemble_method='voting', weights=None):
    - track_archetype: Track type for historical estimator
    - ensemble_method: 'voting' or 'stacking'
    - weights: Optional custom weights for voting [w_hist, w_proj, w_salary, w_recent]
  - __post_init__:
    - Initialize all four base estimators
    - Build VotingRegressor or StackingRegressor from scikit-learn
    - For voting: use weights if provided, else equal weights
    - For stacking: use BayesianRidge as meta-learner with 5-fold CV

- fit(X, y) should:
  - Accept feature matrix X with all required columns
  - Fit each base estimator
  - Fit ensemble meta-learner (if stacking)
  - Compute permutation feature importance
  - Log feature importance rankings
  - Return self

- predict(X) should:
  - Generate predictions from ensemble
  - Clip to [0, 100] range
  - Normalize to sum to 100% across all drivers
  - Return ownership predictions

- predict_with_uncertainty(X, n_bootstraps=100) should:
  - Run bootstrap resampling
  - Compute mean, std, 5th percentile, 95th percentile
  - Return dict with uncertainty bounds
  - Use numpy for efficient aggregation

DO NOT:
- Don't add dynamic weight learning yet (keep weights static for now)
- Don't add track-archetype specific ensembling yet (single model per call)

Reference RESEARCH.md section "Pattern 1: Hybrid Ensemble Ownership Estimation" for complete implementation example.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.ensemble import HybridOwnershipEstimator
import pandas as pd
import numpy as np

# Create sample feature matrix
X = pd.DataFrame({
    'driver_id': range(1, 11),
    'salary': [10000 - i*500 for i in range(10)],
    'projected_points': [50 - i*2 for i in range(10)],
    'skill': [0.9 - i*0.05 for i in range(10)],
    'recent_avg_finish': [5 + i*2 for i in range(10)],
    'track_archetype': ['superspeedway'] * 10,
    'race_date': pd.Timestamp('2024-02-01')
})
y = np.array([25.0, 20.0, 15.0, 12.0, 10.0, 8.0, 6.0, 5.0, 4.0, 3.0])

# Test voting ensemble
est_voting = HybridOwnershipEstimator(ensemble_method='voting')
est_voting.fit(X, y)
preds_voting = est_voting.predict(X)
print(f'Voting ensemble predictions: {preds_voting[:3]}')

# Test stacking ensemble
est_stacking = HybridOwnershipEstimator(ensemble_method='stacking')
est_stacking.fit(X, y)
preds_stacking = est_stacking.predict(X)
print(f'Stacking ensemble predictions: {preds_stacking[:3]}')

# Test uncertainty bounds
uncertainty = est_voting.predict_with_uncertainty(X, n_bootstraps=10)
print(f'Uncertainty bounds for driver 1: {uncertainty[\"mean\"][0]:.1f} +/- {uncertainty[\"std\"][0]:.1f}')

print('Hybrid ensemble test passed')
"
```
  </verify>
  <done>
HybridOwnershipEstimator created with:
- Combines 4 base estimators (historical, projections, salary-skill, recent form)
- Supports voting (simple average) and stacking (meta-learner)
- predict_with_uncertainty() provides bootstrap confidence bounds
- Feature importance logging
- Normalizes predictions to sum to 100%
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ownership Pydantic models</name>
  <files>apps/backend/app/ownership/models.py</files>
  <action>
Create Pydantic models for ownership validation:

**File: apps/backend/app/ownership/models.py**
- OwnershipRequest model:
  - driver_data: List[DriverOwnershipData]
  - race_data: RaceOwnershipData
  - ensemble_method: str = 'voting'
  - n_recent_races: int = 5
  - include_uncertainty: bool = False

- DriverOwnershipData model:
  - driver_id: int
  - salary: int
  - projected_points: Optional[float] = None
  - skill: Optional[float] = None
  - recent_avg_finish: Optional[float] = None

- RaceOwnershipData model:
  - race_id: int
  - track_archetype: str
  - race_date: datetime

- OwnershipResponse model:
  - ownership_predictions: List[OwnershipPrediction]
  - ensemble_method: str
  - feature_importance: Optional[Dict[str, float]] = None

- OwnershipPrediction model:
  - driver_id: int
  - ownership_percent: float
  - uncertainty_lower: Optional[float] = None
  - uncertainty_upper: Optional[float] = None

Add validation:
- track_archetype must be one of: superspeedway, intermediate, short_track, road_course
- ownership_percent must be in [0, 100]
- salary must be positive

Reference existing Pydantic models in apps/backend/app/models.py for patterns.
  </action>
  <verify>
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.models import (
    OwnershipRequest,
    DriverOwnershipData,
    RaceOwnershipData,
    OwnershipResponse,
    OwnershipPrediction
)
from datetime import datetime

# Create sample request
request = OwnershipRequest(
    driver_data=[
        DriverOwnershipData(
            driver_id=1,
            salary=10000,
            projected_points=50.0,
            skill=0.9,
            recent_avg_finish=5.0
        )
    ],
    race_data=RaceOwnershipData(
        race_id=1,
        track_archetype='superspeedway',
        race_date=datetime(2024, 2, 1)
    ),
    ensemble_method='voting'
)

# Create sample response
response = OwnershipResponse(
    ownership_predictions=[
        OwnershipPrediction(
            driver_id=1,
            ownership_percent=25.0,
            uncertainty_lower=20.0,
            uncertainty_upper=30.0
        )
    ],
    ensemble_method='voting',
    feature_importance={'salary': 0.4, 'skill': 0.3, 'projected_points': 0.3}
)

print('Ownership models test passed')
print(f'Request: {request.driver_data[0].driver_id}')
print(f'Response: {response.ownership_predictions[0].ownership_percent}%')
"
```
  </verify>
  <done>
Pydantic models created with:
- OwnershipRequest validates driver/race input data
- OwnershipResponse validates predictions with optional uncertainty
- Track archetype validation (superspeedway, intermediate, short_track, road_course)
- Ownership percent range validation [0, 100]
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Recent form estimator**: Calculates weighted rolling ownership with decay
2. **Hybrid ensemble**: Combines all 4 estimators with voting or stacking
3. **Uncertainty bounds**: Bootstrap confidence intervals computed correctly
4. **Pydantic validation**: All models validate input/output correctly
5. **Integration**: Ensemble imports and uses all base estimators

Run verification:
```bash
cd /Users/zax/Desktop/nascar-model\ copy\ 2
python -c "
from apps.backend.app.ownership.ensemble import HybridOwnershipEstimator
from apps.backend.app.ownership.models import OwnershipRequest, OwnershipResponse
from apps.backend.app.ownership.recent_form import RecentFormEstimator
print('All ownership components imported successfully')
"
```
</verification>

<success_criteria>
1. RecentFormEstimator implements rolling ownership with decay
2. HybridOwnershipEstimator combines 4 base estimators
3. predict_with_uncertainty() provides confidence bounds
4. Pydantic models validate all ownership data
5. All estimators handle missing data gracefully
6. Unit tests pass for all components
</success_criteria>

<output>
After completion, create `.planning/phases/04-field-ownership-contest-sim/04-02-SUMMARY.md`
</output>
