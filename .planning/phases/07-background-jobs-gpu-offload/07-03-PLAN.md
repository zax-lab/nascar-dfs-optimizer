---
phase: 07-background-jobs-gpu-offload
plan: 03
type: execute
wave: 1
depends_on: [07-02]
files_modified: [
  apps/native_mac/gui/views/optimization_tab.py,
  apps/native_mac/gui/views/jobs_tab.py,
  apps/native_mac/gui/main_window.py,
  apps/native_mac/main.py
]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - User can toggle GPU offload in Optimization tab before running job
    - Jobs submitted from Optimization tab go through JobManager queue
    - Re-run button in Jobs tab actually submits job to queue
    - Cancel button in Jobs tab cancels queued/running jobs
  artifacts:
    - path: apps/native_mac/gui/views/optimization_tab.py
      provides: GPU offload checkbox and JobManager integration
      changes: "Added gpu_offload QCheckBox, modified run_optimization to use job_manager.submit_job()"
    - path: apps/native_mac/gui/main_window.py
      provides: JobsTab wired to JobManager
      changes: "Pass job_manager to JobsTab constructor"
    - path: apps/native_mac/main.py
      provides: Signal connections for re-run and job submission
      changes: "Connect rerun_job_requested to job_manager.submit_job()"
  key_links:
    - from: apps/native_mac/gui/views/optimization_tab.py
      to: apps/native_mac/jobs/job_manager.py
      via: job_manager.submit_job() call with gpu_offload flag
      pattern: self.job_manager.submit_job\(config\)
    - from: apps/native_mac/gui/views/jobs_tab.py
      to: apps/native_mac/jobs/job_manager.py
      via: job_manager parameter and signal connections
      pattern: self.job_manager.cancel_job\(\) and rerun_job_requested.connect
---

<objective>
Wire up UI components to complete Phase 7: Add GPU offload toggle to Optimization tab, connect JobsTab to JobManager, and ensure re-run/cancel functionality works.

Purpose: Close verification gaps that prevent users from actually using the GPU offload and job queue features that were built in Plans 07-01 and 07-02.

Output: Fully wired UI where users can toggle GPU offload per-job, submit jobs through the queue, and re-run historical jobs.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/07-background-jobs-gpu-offload/07-VERIFICATION.md
@.planning/phases/07-background-jobs-gpu-offload/07-02-SUMMARY.md

**Gaps to close (from VERIFICATION.md):**

**Gap 1: GPU Offload Toggle Missing**
- File: apps/native_mac/gui/views/optimization_tab.py
- Issue: No GPU offload checkbox in optimization settings
- Missing: QCheckBox, connection to config, visual indicator

**Gap 2: Jobs Tab Not Connected to JobManager**
- Files: main_window.py line 125-126, main.py
- Issue: JobsTab created without job_manager parameter
- Missing: job_manager param, rerun_job_requested signal connection

**Gap 3: Optimization Tab Uses Legacy Engine**
- File: optimization_tab.py lines 280-290
- Issue: Uses optimization_engine.start_optimization() directly
- Missing: Migration to job_manager.submit_job()

**Existing infrastructure (working):**
- JobManager with ThreadPoolExecutor (07-01)
- GPUWorkerClient with HTTP methods (07-02)
- JobsTab with UI for filtering, search, re-run button (07-02)
- JobDetailsDialog with tabs and re-run signal (07-02)
- SettingsTab with GPU configuration (07-02)

**Key implementation notes:**
- JobManager instance already created in main.py
- JobsTab already emits rerun_job_requested signal
- Optimization tab already has settings group (lineup count, iterations)
- Just need to ADD gpu_offload checkbox and WIRE to job_manager
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GPU offload toggle to Optimization tab</name>
  <files>apps/native_mac/gui/views/optimization_tab.py</files>
  <action>
Add GPU offload toggle and integrate with JobManager:

1. In OptimizationTab.__init__():
   - Add job_manager parameter and store as self.job_manager
   - Add gpu_offload checkbox to settings group:
     ```python
     self.gpu_checkbox = QCheckBox("Use GPU offload")
     self.gpu_checkbox.setToolTip("Route job to Windows GPU worker (5-10s vs 30-60s)")
     # Add to settings_layout after iterations spinner
     ```

2. Modify on_run_optimization() method:
   - Replace direct optimization_engine.start_optimization() call
   - Build config dict with all settings including gpu_offload flag
   - Call self.job_manager.submit_job(config) instead
   - Show confirmation message: "Job 'Name' submitted (ID: abc123)"
   - Config dict structure:
     ```python
     config = {
         'race_id': race_id,
         'race_name': race_name,
         'job_name': self.name_input.text() or f"{track_name} Optimization",
         'num_lineups': self.lineup_count_spin.value(),
         'iterations': self.iterations_spin.value(),
         'gpu_offload': self.gpu_checkbox.isChecked(),
         'constraints': {
             'salary_cap': 50000,
             'max_exposure': self.max_exposure_spin.value(),
             'min_salary': self.min_salary_spin.value(),
         },
         'drivers': self.drivers  # Current driver data
     }
     ```

3. Update constructor signature:
   - Change from: `__init__(self, parent=None)`
   - To: `__init__(self, job_manager=None, parent=None)`

4. Handle missing job_manager gracefully:
   - If job_manager is None, show error: "Job manager not available"
   - Or fall back to legacy behavior with warning

5. Visual feedback:
   - When gpu_checkbox is checked, show status label: "GPU mode: Will route to Windows worker"
   - When unchecked: "Local mode: Running on Mac CPU"
   - Update label text when checkbox state changes

6. Do NOT remove legacy optimization_engine code - keep as fallback
7. Do NOT change other UI elements - only add GPU checkbox and modify submission
  </action>
  <verify>
python -c "
from apps.native_mac.gui.views.optimization_tab import OptimizationTab
from PySide6.QtWidgets import QApplication
app = QApplication([])
# Check that OptimizationTab accepts job_manager parameter
tab = OptimizationTab(job_manager=None)
assert hasattr(tab, 'job_manager')
assert hasattr(tab, 'gpu_checkbox')
print('OptimizationTab GPU integration successful')
"
  </verify>
  <done>Optimization tab has GPU offload checkbox and submits jobs via JobManager</done>
</task>

<task type="auto">
  <name>Task 2: Wire JobsTab to JobManager</name>
  <files>apps/native_mac/gui/views/jobs_tab.py, apps/native_mac/gui/main_window.py, apps/native_mac/main.py</files>
  <action>
Connect JobsTab to JobManager for working re-run and cancel:

1. Modify apps/native_mac/gui/views/jobs_tab.py:
   - Update __init__ signature:
     ```python
     def __init__(self, database_manager, job_manager=None, parent=None):
     ```
   - Store job_manager: self.job_manager = job_manager
   - In _cancel_job() method:
     * Check if self.job_manager exists
     * Call self.job_manager.cancel_job(job_id) instead of just updating UI
     * Handle cancellation error gracefully
   - In _rerun_job() method:
     * Check if self.job_manager exists
     * After getting config, call self.job_manager.submit_job(config)
     * Show confirmation with new job ID
   - In _view_job_details() method:
     * Pass job_manager to dialog if needed for context

2. Modify apps/native_mac/gui/main_window.py:
   - In create_tabs() method around line 125:
     ```python
     # Change from:
     self.jobs_tab = JobsTab(database_manager=self.db_manager)
     # To:
     self.jobs_tab = JobsTab(
         database_manager=self.db_manager,
         job_manager=getattr(self, 'job_manager', None)
     )
     ```
   - Make sure job_manager is available as self.job_manager (set via constructor or property)

3. Modify apps/native_mac/main.py:
   - After creating window and job_manager:
     ```python
     # Pass job_manager to main window for tabs
     window.job_manager = job_manager
     
     # Connect JobsTab re-run signal to JobManager
     if hasattr(window, 'jobs_tab') and window.jobs_tab:
         window.jobs_tab.rerun_job_requested.connect(
             lambda config: job_manager.submit_job(config)
         )
     
     # Connect JobsTab cancel signal
     if hasattr(window.jobs_tab, 'cancel_job_requested'):
         window.jobs_tab.cancel_job_requested.connect(
             lambda job_id: job_manager.cancel_job(job_id)
         )
     ```

4. Add property to MainWindow for job_manager access:
   - In MainWindow.__init__(), add: self.job_manager = None
   - Or accept job_manager as constructor parameter

5. Handle edge cases:
   - If job_manager is None, disable re-run/cancel buttons in JobsTab
   - Show tooltip: "Job manager not available" on disabled buttons
   - Log warning if signals not connected

6. Do NOT change JobsTab UI structure - only wire up existing buttons
7. Do NOT create circular imports - main.py already has both job_manager and window
  </action>
  <verify>
python -c "
from apps.native_mac.gui.views.jobs_tab import JobsTab
from PySide6.QtWidgets import QApplication
app = QApplication([])
# Check JobsTab accepts job_manager parameter
tab = JobsTab(database_manager=None, job_manager=None)
assert hasattr(tab, 'job_manager')
assert hasattr(tab, 'rerun_job_requested')
print('JobsTab JobManager integration successful')
"
  </verify>
  <done>JobsTab connected to JobManager with working re-run and cancel</done>
</task>

<task type="auto">
  <name>Task 3: Update main.py to wire all components</name>
  <files>apps/native_mac/main.py</files>
  <action>
Ensure main.py properly wires JobManager to all tabs:

1. After creating job_manager and window:
   - Pass job_manager to window: window.job_manager = job_manager
   - Recreate optimization tab with job_manager if needed:
     ```python
     # If optimization_tab was created before job_manager
     if hasattr(window, 'optimization_tab'):
         window.optimization_tab.job_manager = job_manager
     ```

2. Connect all signals:
   - JobsTab re-run to job_manager.submit_job()
   - JobsTab cancel to job_manager.cancel_job()
   - OptimizationTab (if it has signals) to appropriate handlers

3. Ensure proper initialization order:
   - Create app
   - Create session_manager, database_manager
   - Create job_manager (needs database_manager, gpu_client)
   - Create main window (pass database_manager)
   - Pass job_manager to window and tabs
   - Connect signals
   - Show window

4. Add debug logging:
   - Log when job_manager is wired to tabs
   - Log signal connections
   - Helpful for troubleshooting

5. Test imports:
   - Ensure no circular import issues
   - All modules load correctly

6. Do NOT change existing functionality - only add wiring
7. Do NOT break existing session restore or other features
  </action>
  <verify>
python -c "
# Import main and check structure
from apps.native_mac import main
print('main.py imports successfully')
# Check that key functions exist
assert hasattr(main, 'main')
print('main() function exists')
"
  </verify>
  <done>main.py wires JobManager to all tabs with proper signal connections</done>
</task>

</tasks>

<verification>
1. Open Optimization tab - see GPU offload checkbox
2. Check GPU checkbox - see "GPU mode" status label
3. Submit optimization - see "Job submitted" confirmation with ID
4. Job appears in Jobs tab with status "queued" or "running"
5. In Jobs tab, select completed job, click Re-run - new job created with (re-run) suffix
6. Select running job, click Cancel - job status changes to "cancelled"
7. Verify Dock badge shows job count during active jobs
</verification>

<success_criteria>
- Optimization tab has GPU offload checkbox that toggles gpu_offload config flag
- Jobs submitted from Optimization tab go through JobManager queue (not legacy engine)
- JobsTab receives job_manager parameter and uses it for cancel/re-run
- Re-run button submits job to queue and shows confirmation
- Cancel button cancels job via JobManager
- All existing functionality preserved (session restore, settings, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/07-background-jobs-gpu-offload/07-03-SUMMARY.md`
</output>
