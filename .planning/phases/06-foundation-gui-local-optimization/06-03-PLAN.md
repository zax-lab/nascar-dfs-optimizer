---
phase: 06-foundation-gui-local-optimization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/native_mac/gui/models/driver_model.py
  - apps/native_mac/gui/models/lineup_model.py
  - apps/native_mac/gui/models/race_model.py
autonomous: true

must_haves:
  truths:
    - "DriverTableModel subclasses QAbstractTableModel and displays driver data in QTableView"
    - "DriverTableModel has columns: Driver, Salary, ProjPts, Own%, Team"
    - "LineupTableModel subclasses QAbstractTableModel and displays optimized lineups"
    - "RaceTableModel subclasses QAbstractTableModel and displays race history"
    - "Models emit dataChanged signals when data updates"
    - "Models support sorting via QSortFilterProxyModel integration"
  artifacts:
    - path: "apps/native_mac/gui/models/driver_model.py"
      provides: "QAbstractTableModel for driver list display"
      contains: "class DriverTableModel"
    - path: "apps/native_mac/gui/models/lineup_model.py"
      provides: "QAbstractTableModel for lineup table display"
      contains: "class LineupTableModel"
    - path: "apps/native_mac/gui/models/race_model.py"
      provides: "QAbstractTableModel for race history display"
      contains: "class RaceTableModel"
  key_links:
    - from: "apps/native_mac/gui/models/driver_model.py"
      to: "PySide6.QtCore.QAbstractTableModel"
      via: "from PySide6.QtCore import QAbstractTableModel"
      pattern: "class DriverTableModel.*QAbstractTableModel"
    - from: "apps/native_mac/gui/models/lineup_model.py"
      to: "PySide6.QtCore.QAbstractTableModel"
      via: "from PySide6.QtCore import QAbstractTableModel"
      pattern: "class LineupTableModel.*QAbstractTableModel"
---

## Objective

Create Qt Model/View architecture components for displaying driver data, optimized lineups, and race history in table views. This separates data models from UI display, enabling sorting, filtering, and automatic UI updates via Qt's signal/slot mechanism.

**Purpose:** Qt's Model/View architecture is critical for professional table displays. Direct table manipulation (QTableWidget) doesn't scale, can't sort efficiently, and violates separation of concerns. Custom models enable clean data binding and automatic UI updates.

**Output:** Working QAbstractTableModel subclasses for drivers, lineups, and races that can be used with QTableView and QSortFilterProxyModel.

## Context

@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation-gui-local-optimization/06-RESEARCH.md

@apps/backend/app/models.py

## Tasks

<task type="auto">
  <name>Create DriverTableModel for driver list display</name>
  <files>apps/native_mac/gui/models/driver_model.py</files>
  <action>
Create QAbstractTableModel subclass for displaying driver data in QTableView:

1. Create `apps/native_mac/gui/models/` directory with `__init__.py`

2. Create `driver_model.py` with DriverTableModel class:
   - Subclass QAbstractTableModel
   - Columns: Driver, Salary, ProjPts, Own%, Team (5 columns)
   - Accepts list of driver dicts in constructor
   - Implements required methods: rowCount, columnCount, data, headerData

3. Implement data() method with roles:
   - Qt.DisplayRole: returns formatted values (salary as $XX,XXX, points as X.X)
   - Qt.BackgroundRole: color-code high-value drivers (>3.0 pts/$1000 in green, <1.5 in red)
   - Qt.TextAlignmentRole: right-align numeric columns
   - Return None for unsupported roles

4. Implement update_data(drivers) method:
   - Calls beginResetModel() before updating
   - Updates self._drivers list
   - Calls endResetModel() after updating (triggers UI refresh)

5. Add flags() method returning ItemIsEnabled | ItemIsSelectable

Follow research pattern from 06-RESEARCH.md > Pattern 1: Qt Model/View Architecture.
  </action>
  <verify>
DriverTableModel subclasses QAbstractTableModel
rowCount returns len(self._drivers)
columnCount returns 5
data() handles DisplayRole, BackgroundRole, TextAlignmentRole
headerData returns column names
update_data() method exists and calls begin/endResetModel
  </verify>
  <done>
DriverTableModel created and functional
Can display driver list with formatted columns
Color-coding for value scores working
Models can be updated with new data
  </done>
</task>

<task type="auto">
  <name>Create LineupTableModel for optimized lineups display</name>
  <files>apps/native_mac/gui/models/lineup_model.py</files>
  <action>
Create QAbstractTableModel subclass for displaying optimized lineups:

1. Create `lineup_model.py` with LineupTableModel class:
   - Subclass QAbstractTableModel
   - Columns: Lineup #, Driver 1, Driver 2, Driver 3, Driver 4, Driver 5, Driver 6, Total Salary, ProjPts (9 columns)
   - Accepts list of lineup dicts in constructor
   - Each lineup has: id, drivers (list), total_salary, projected_points

2. Implement data() method with roles:
   - Qt.DisplayRole: returns lineup data (driver names, totals)
   - Qt.BackgroundRole: color-code top projected lineups (top 20% in light green)
   - Qt.TextAlignmentRole: right-align numeric columns

3. Implement headerData() for column labels

4. Implement update_data(lineups) method:
   - Calls beginResetModel() before updating
   - Updates self._lineups list
   - Calls endResetModel() after updating

5. Add get_lineup(row) method to retrieve full lineup data for export

Reference: DraftKings NASCAR requires 6 drivers per lineup.
  </action>
  <verify>
LineupTableModel subclasses QAbstractTableModel
rowCount returns len(self._lineups)
columnCount returns 9
data() handles DisplayRole for all columns
get_lineup(row) method returns full lineup data
update_data() method exists
  </verify>
  <done>
LineupTableModel created and functional
Can display optimized lineups with 6 drivers each
Total salary and projected points columns working
Models can be updated with new optimization results
  </done>
</task>

<task type="auto">
  <name>Create RaceTableModel for race history display</name>
  <files>apps/native_mac/gui/models/race_model.py</files>
  <action>
Create QAbstractTableModel subclass for displaying race history:

1. Create `race_model.py` with RaceTableModel class:
   - Subclass QAbstractTableModel
   - Columns: Track, Race Date, Lineups Generated, Created At (4 columns)
   - Accepts list of Race objects (from persistence.models)
   - Displays historical races with lineup counts

2. Implement data() method with roles:
   - Qt.DisplayRole: returns race information
   - Qt.TextAlignmentRole: center-align track names, right-align counts
   - Format dates nicely (YYYY-MM-DD)

3. Implement headerData() for column labels

4. Implement update_data(races) method:
   - Calls beginResetModel() before updating
   - Updates self._races list
   - Calls endResetModel() after updating

5. Add get_race_id(row) method to retrieve race ID for loading

This model will be used in the "Race Data" tab to select historical races.
  </action>
  <verify>
RaceTableModel subclasses QAbstractTableModel
rowCount returns len(self._races)
columnCount returns 4
data() handles DisplayRole for all columns
get_race_id(row) method returns race ID
update_data() method exists
  </verify>
  <done>
RaceTableModel created and functional
Can display race history with formatted dates
Race selection via ID working
Models can be updated when new races are created
  </done>
</task>

## Verification

After completing all tasks, verify the models:

1. Create test script that instantiates each model with sample data
2. Verify rowCount/columnCount return correct values
3. Verify data() returns proper formatted values for DisplayRole
4. Verify BackgroundRole returns QColor objects for conditional formatting
5. Test update_data() methods trigger proper model reset signals
6. Verify models can be used with QTableView (basic smoke test)

## Success Criteria

- [ ] DriverTableModel displays 5 columns with formatted values
- [ ] DriverTableModel color-codes value scores
- [ ] LineupTableModel displays 9 columns for lineups
- [ ] LineupTableModel shows 6 drivers per lineup
- [ ] RaceTableModel displays 4 columns for race history
- [ ] All models implement update_data() for UI refresh
- [ ] All models subclass QAbstractTableModel (not QStandardItemModel)

## Output

After completion, create `.planning/phases/06-foundation-gui-local-optimization/06-03-SUMMARY.md`
