---
phase: 06-foundation-gui-local-optimization
plan: 07
type: execute
wave: 3
depends_on: ["06-04", "06-06"]
files_modified:
  - apps/native_mac/gui/widgets/constraint_panel.py
  - apps/native_mac/gui/widgets/progress_dialog.py
  - apps/native_mac/gui/views/optimization_tab.py
  - apps/native_mac/gui/main_window.py
autonomous: true

must_haves:
  truths:
    - "User can set optimization constraints (salary cap, exposure limits, stacking rules) in Optimization tab"
    - "Progress dialog shows MCMC optimization progress with cancel button"
    - "Lineup count selector allows choosing 10-150 lineups to generate"
    - "Constraint inputs validate user input and show error messages for invalid values"
    - "Optimization tab has 'Run Optimization' button that triggers the optimization workflow"
  artifacts:
    - path: "apps/native_mac/gui/widgets/constraint_panel.py"
      provides: "ConstraintPanel widget for salary/exposure/stacking inputs"
      contains: "class ConstraintPanel"
    - path: "apps/native_mac/gui/widgets/progress_dialog.py"
      provides: "ProgressDialog with progress bar and cancel button"
      contains: "class ProgressDialog"
    - path: "apps/native_mac/gui/views/optimization_tab.py"
      provides: "OptimizationTab with constraints, progress, and run button"
      contains: "class OptimizationTab"
  key_links:
    - from: "apps/native_mac/gui/views/optimization_tab.py"
      to: "apps/native_mac/gui/widgets/constraint_panel.py"
      via: "ConstraintPanel integration"
      pattern: "from.*widgets.constraint_panel import ConstraintPanel"
    - from: "apps/native_mac/gui/views/optimization_tab.py"
      to: "apps/native_mac/gui/widgets/progress_dialog.py"
      via: "ProgressDialog for optimization"
      pattern: "from.*widgets.progress_dialog import ProgressDialog"
    - from: "apps/native_mac/gui/views/optimization_tab.py"
      to: "apps/native_mac/optimization/engine.py"
      via: "OptimizationEngine for running optimization"
      pattern: "from.*optimization.engine import OptimizationEngine"
---

## Objective

Create the Optimization tab UI with constraint inputs (salary cap, exposure limits, stacking rules), progress indication dialog, and the Run Optimization button that triggers the local JAX-based optimizer.

**Purpose:** Users need a way to configure optimization parameters, see progress during the 30-60 second MCMC run, and trigger the lineup generation. This is the primary interaction point for the optimization feature.

**Output:** Fully functional Optimization tab with constraint UI, progress dialog, and run button integration.

## Context

@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation-gui-local-optimization/06-RESEARCH.md
@.planning/phases/06-foundation-gui-local-optimization/06-04-SUMMARY.md
@.planning/phases/06-foundation-gui-local-optimization/06-06-SUMMARY.md

## Tasks

<task type="auto">
  <name>Create ConstraintPanel widget for optimization constraints</name>
  <files>apps/native_mac/gui/widgets/constraint_panel.py</files>
  <action>
Create ConstraintPanel widget with input fields for optimization constraints:

1. Create `apps/native_mac/gui/widgets/` directory with `__init__.py`

2. Create `constraint_panel.py` with ConstraintPanel class (subclass QWidget):

3. Layout with QFormLayout for clean label-input alignment:
   - Salary Cap: QSpinBox (range $40,000-$60,000, default $50,000, step $100)
   - Min Salary: QSpinBox (range $0-$45,000, default $46,000, step $100)
   - Max Ownership: QDoubleSpinBox (range 0-100%, default 50%, step 1%)
   - Min Ownership: QDoubleSpinBox (range 0-100%, default 0%, step 1%)
   - Stacking Rules: QGroupBox with checkboxes
     - Allow teammates: QCheckBox (default checked)
     - Max teammates: QSpinBox (range 2-6, default 3)

4. Implement get_constraints() method:
```python
def get_constraints(self) -> dict:
    """Return current constraint values as dict."""
    return {
        'salary_cap': self.salary_cap_spin.value(),
        'min_salary': self.min_salary_spin.value(),
        'max_ownership': self.max_ownership_spin.value() / 100,
        'min_ownership': self.min_ownership_spin.value() / 100,
        'stacking': {
            'allow_teammates': self.allow_teammates_check.isChecked(),
            'max_teammates': self.max_teammates_spin.value()
        }
    }
```

5. Implement set_constraints(constraints) method:
   - Update all input widgets from dict
   - Used for loading saved configurations

6. Input validation:
   - Min salary must be < salary cap
   - Min ownership must be < max ownership
   - Show validation error in status label

7. Save/Load preset buttons:
   - "Save Preset" button - saves current constraints to database
   - "Load Preset" button - loads saved preset from QComboBox

Follow research pattern from 06-RESEARCH.md > Constraint Input Panel.
  </action>
  <verify>
ConstraintPanel subclasses QWidget
QFormLayout with labeled inputs for all constraints
get_constraints() returns dict with all values
set_constraints() updates input widgets
Validation logic for min/max constraints
Save/Load preset buttons present
  </verify>
  <done>
ConstraintPanel widget created
All constraint inputs present and functional
Validation prevents invalid constraint combinations
Preset save/load working
  </done>
</task>

<task type="auto">
  <name>Create ProgressDialog with progress bar and cancel button</name>
  <files>apps/native_mac/gui/widgets/progress_dialog.py</files>
  <action>
Create ProgressDialog for showing MCMC optimization progress:

1. Create `progress_dialog.py` with ProgressDialog class (subclass QDialog):

2. Dialog layout:
   - Title: "Generating Lineups"
   - QLabel: "Running MCMC optimization..."
   - QProgressBar: range 0-100, text visible ("Iteration 50/1000")
   - QLabel: "Current best score: 245.3"
   - Cancel button: QPushButton("Cancel")

3. Constructor accepts:
   - max_iterations: int (for progress bar maximum)
   - parent: QWidget (optional)

4. Implement update_progress(current, total, best_score):
```python
def update_progress(self, current: int, total: int, best_score: float):
    percentage = int((current / total) * 100)
    self.progress_bar.setValue(percentage)
    self.progress_bar.setFormat(f"Iteration {current}/{total}")
    self.score_label.setText(f"Current best score: {best_score:.1f}")
```

5. Cancel functionality:
   - Cancel button emits cancelled() signal
   - Dialog stays open but shows "Cancelling..."
   - closeEvent override to emit cancelled signal

6. Dialog properties:
   - setModal(True) - blocks interaction with main window
   - setWindowTitle("Optimization Progress")
   - Minimum size: 400x150
   - Non-resizable

7. Success completion:
   - When optimization finishes, dialog auto-closes
   - Or shows "Complete!" with "View Results" button

Follow research pattern from 06-RESEARCH.md > QProgressDialog Pattern.
  </action>
  <verify>
ProgressDialog subclasses QDialog
QProgressBar with 0-100 range and text format
update_progress method updates bar and labels
Cancel button emits cancelled signal
Modal dialog blocks main window
Auto-closes on optimization completion
  </verify>
  <done>
ProgressDialog widget created
Progress bar shows iteration progress
Cancel button functional
Score display updates in real-time
  </done>
</task>

<task type="auto">
  <name>Create OptimizationTab integrating constraints, progress, and run button</name>
  <files>apps/native_mac/gui/views/optimization_tab.py, apps/native_mac/gui/main_window.py</files>
  <action>
Create OptimizationTab that brings together all optimization UI components:

1. Create `optimization_tab.py` with OptimizationTab class (subclass QWidget):

2. Tab layout structure:
   - Top: Race selector (QComboBox showing loaded races)
   - Middle: ConstraintPanel widget
   - Bottom: Lineup count selector (QSpinBox: 10-150, default 20)
   - Bottom: Iterations selector (QSpinBox: 100-5000, default 1000)
   - Bottom: "Run Optimization" button (large, prominent)

3. Constructor dependencies:
   - database_manager: DatabaseManager
   - optimization_engine: OptimizationEngine
   - parent: QWidget (optional)

4. Implement on_run_optimization() slot:
```python
def on_run_optimization(self):
    # Validate: must have drivers loaded
    if not self.current_race_id:
        QMessageBox.warning(self, "No Race Data", "Please import driver data first.")
        return

    # Get constraints from panel
    constraints = self.constraint_panel.get_constraints()
    num_lineups = self.lineup_count_spin.value()

    # Show progress dialog
    self.progress_dialog = ProgressDialog(max_iterations=1000, parent=self)
    self.progress_dialog.cancelled.connect(self.on_cancel_optimization)
    self.progress_dialog.show()

    # Start optimization
    drivers = self.load_drivers_for_race(self.current_race_id)
    self.current_worker = self.optimization_engine.start_optimization(
        race_id=self.current_race_id,
        drivers=drivers,
        constraints=constraints,
        progress_callback=self.on_progress_update,
        finished_callback=self.on_optimization_finished
    )
```

5. Implement callback handlers:
```python
def on_progress_update(self, current, total, best_score):
    if self.progress_dialog:
        self.progress_dialog.update_progress(current, total, best_score)

def on_optimization_finished(self, lineups):
    if self.progress_dialog:
        self.progress_dialog.close()
    self.lineups_generated.emit(lineups)
    QMessageBox.information(self, "Complete", f"Generated {len(lineups)} lineups!")
```

6. Implement cancellation:
```python
def on_cancel_optimization(self):
    if self.current_worker:
        self.current_worker.cancel()
        self.current_worker.wait()  # Wait for thread to finish
```

7. Update main_window.py:
   - Import OptimizationTab and OptimizationEngine
   - Instantiate OptimizationEngine with DatabaseManager
   - Replace placeholder in create_optimization_tab() with real OptimizationTab
   - Connect lineups_generated signal to LineupTableModel update

Follow research pattern from 06-RESEARCH.md > Optimization Tab Integration.
  </action>
  <verify>
OptimizationTab subclasses QWidget
ConstraintPanel integrated in layout
Lineup count selector (10-150 range)
Run Optimization button triggers on_run_optimization
Progress dialog shows during optimization
Cancellation stops worker thread
Lineups saved to database and emitted via signal
  </verify>
  <done>
OptimizationTab created with all UI components
Run Optimization button functional
Progress dialog displays during MCMC run
Cancellation mechanism working
Lineups generated and saved to database
  </done>
</task>

## Verification

After completing all tasks, verify the optimization UI:

1. Launch application, import driver data
2. Navigate to Optimization tab
3. Verify constraint inputs present and functional:
   - Change salary cap, verify range validation
   - Test min/max ownership constraints
   - Toggle stacking rules
4. Click "Run Optimization" button
5. Verify progress dialog appears with:
   - Progress bar updating
   - Iteration count showing
   - Best score updating
   - Cancel button active
6. Test cancellation - verify optimization stops cleanly
7. Let optimization complete - verify lineups saved
8. Check Lineups tab - verify generated lineups displayed

## Success Criteria

- [ ] Optimization tab shows all constraint inputs
- [ ] Salary cap, exposure limits, stacking rules configurable
- [ ] Progress dialog appears with progress bar and cancel button
- [ ] Progress updates every 10 iterations during MCMC
- [ ] Cancel button stops optimization cleanly
- [ ] Generated lineups saved to database automatically
- [ ] Lineup count selector (10-150) functional
- [ ] Validation prevents running without loaded race data

## Output

After completion, create `.planning/phases/06-foundation-gui-local-optimization/06-07-SUMMARY.md`
