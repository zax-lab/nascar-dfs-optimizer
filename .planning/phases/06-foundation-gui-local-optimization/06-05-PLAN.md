---
phase: 06-foundation-gui-local-optimization
plan: 05
type: execute
wave: 2
depends_on: ["06-02"]
files_modified:
  - apps/native_mac/gui/controllers/data_controller.py
  - apps/native_mac/gui/views/driver_table.py
  - apps/native_mac/gui/main_window.py
autonomous: true

must_haves:
  truths:
    - "User can click File > Open Data File to select CSV file via native macOS file dialog"
    - "Selected CSV file is imported using pandas with error handling"
    - "Driver data displays in Race Data tab table view after import"
    - "Import errors show user-friendly error dialog (not raw traceback)"
    - "Imported driver data is saved to database via DatabaseManager"
  artifacts:
    - path: "apps/native_mac/gui/controllers/data_controller.py"
      provides: "DataController for CSV import/export operations"
      contains: "class DataController"
    - path: "apps/native_mac/gui/views/driver_table.py"
      provides: "Driver table view widget with import integration"
      contains: "class DriverTableView"
    - path: "apps/native_mac/gui/main_window.py"
      provides: "Updated MainWindow with File > Open menu action"
      contains: "open_file"
  key_links:
    - from: "apps/native_mac/gui/controllers/data_controller.py"
      to: "pandas"
      via: "pd.read_csv for CSV import"
      pattern: "import pandas as pd"
    - from: "apps/native_mac/gui/controllers/data_controller.py"
      to: "apps/native_mac/persistence/database.py"
      via: "DatabaseManager for saving imported data"
      pattern: "from.*persistence.database import DatabaseManager"
    - from: "apps/native_mac/gui/views/driver_table.py"
      to: "apps/native_mac/gui/models/driver_model.py"
      via: "DriverTableModel for display"
      pattern: "from.*models.driver_model import DriverTableModel"
    - from: "apps/native_mac/gui/main_window.py"
      to: "PySide6.QtWidgets.QFileDialog"
      via: "Native macOS file dialog"
      pattern: "QFileDialog.getOpenFileName"
---

## Objective

Implement CSV data import functionality with native macOS file dialogs, pandas-based parsing with error handling, and database persistence. This enables users to load driver data from CSV files for optimization.

**Purpose:** The optimizer needs driver data (salary, projected points, ownership) to generate lineups. CSV import is the primary data input method. Native file dialogs provide expected macOS user experience with Quick Look and iCloud Drive integration.

**Output:** Working CSV import workflow from file selection to database persistence and UI display.

## Context

@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation-gui-local-optimization/06-RESEARCH.md
@.planning/phases/06-foundation-gui-local-optimization/06-02-SUMMARY.md

## Tasks

<task type="auto">
  <name>Create DataController for CSV import operations</name>
  <files>apps/native_mac/gui/controllers/data_controller.py</files>
  <action>
Create DataController class to handle CSV import and export:

1. Create `apps/native_mac/gui/controllers/` directory with `__init__.py`

2. Create `data_controller.py` with DataController class:
   - Accepts DatabaseManager in constructor
   - Method: import_driver_csv(file_path: str) -> tuple[bool, str, list]
   - Returns: (success, error_message, driver_data_list)

3. Implement pandas-based CSV import:
```python
def import_driver_csv(self, file_path: str) -> tuple[bool, str, list]:
    try:
        # Strict mode: raise error on bad lines
        df = pd.read_csv(file_path, on_bad_lines='error')
    except ParserError as e:
        # Lenient mode: warn and skip bad lines
        df = pd.read_csv(file_path, on_bad_lines='warn')

    # Validate required columns
    required = ['driver_id', 'name', 'salary', 'projected_points']
    missing = [col for col in required if col not in df.columns]
    if missing:
        return False, f"Missing columns: {missing}", []

    # Type coercion
    df['salary'] = pd.to_numeric(df['salary'], errors='coerce')
    df['projected_points'] = pd.to_numeric(df['projected_points'], errors='coerce')
    df['ownership'] = pd.to_numeric(df.get('ownership', 0), errors='coerce')

    # Drop rows with missing critical data
    df = df.dropna(subset=['driver_id', 'salary'])

    # Convert to list of dicts
    drivers = df.to_dict('records')
    return True, "", drivers
```

4. Add save_imported_drivers(race_id, drivers) method to save to database

Follow research pattern from 06-RESEARCH.md > CSV Import with Error Handling.
  </action>
  <verify>
DataController class exists with import_driver_csv method
Method uses pandas read_csv with on_bad_lines parameter
Required column validation implemented
Type coercion for numeric columns
Returns tuple of (success, error_message, driver_data)
save_imported_drivers method exists
  </verify>
  <done>
DataController created with CSV import logic
Error handling for bad CSV data implemented
Database persistence integrated
  </done>
</task>

<task type="auto">
  <name>Create DriverTableView widget with import integration</name>
  <files>apps/native_mac/gui/views/driver_table.py</files>
  <action>
Create DriverTableView widget that integrates table display with data import:

1. Create `apps/native_mac/gui/views/` directory with `__init__.py`

2. Create `driver_table.py` with DriverTableView class:
   - Subclass QTableView
   - Accepts DataController and DriverTableModel in constructor
   - Method: load_drivers_from_csv(file_path) -> bool
   - Method: load_drivers_from_db(race_id) -> bool

3. Implement load_drivers_from_csv:
```python
def load_drivers_from_csv(self, file_path: str) -> bool:
    success, error, drivers = self.data_controller.import_driver_csv(file_path)
    if not success:
        QMessageBox.critical(self, "Import Error", error)
        return False

    self.model.update_data(drivers)
    return True
```

4. Implement status feedback via signal:
   - Define signal: data_loaded = Signal(int) # emits count
   - Emit signal after successful import
   - Connect to MainWindow status bar

5. Configure table display:
   - Column sizing: salary and points columns narrower, name wider
   - Numeric alignment: right-align salary, points, ownership
   - Alternate row colors for readability
  </action>
  <verify>
DriverTableView subclasses QTableView
Accepts DataController and DriverTableModel in constructor
load_drivers_from_csv method implemented
data_loaded signal defined
Error dialog shows on import failure
Column sizing configured properly
  </verify>
  <done>
DriverTableView widget created
CSV import integration working
Error feedback via QMessageBox working
Status signal emission working
  </done>
</task>

<task type="auto">
  <name>Integrate CSV import into MainWindow menu</name>
  <files>apps/native_mac/gui/main_window.py</files>
  <action>
Update MainWindow to connect File > Open menu to CSV import:

1. Update open_file() method (from plan 06-01):
```python
def open_file(self):
    file_path, _ = QFileDialog.getOpenFileName(
        self,
        "Open Driver Data CSV",
        "",
        "CSV Files (*.csv);;All Files (*)"
    )
    if not file_path:
        return

    self.status_bar.showMessage(f"Loading {file_path}...", 0)
    success = self.driver_table.load_drivers_from_csv(file_path)

    if success:
        self.status_bar.showMessage(f"Loaded {file_path}", 3000)
    else:
        self.status_bar.showMessage("Import failed", 3000)
```

2. Update create_race_data_tab() to use DriverTableView:
   - Import DriverTableView from views
   - Instantiate with DataController and DriverTableModel
   - Connect data_loaded signal to status bar updates

3. Add DataController import and instantiation:
   - Import DataController from controllers
   - Create instance in __init__ (pass DatabaseManager)
   - Pass to DriverTableView constructor

4. Update keyboard shortcut:
   - CMD+O now triggers CSV import (standard macOS convention)

Follow research pattern from 06-RESEARCH.md > QFileDialog for native dialogs.
  </action>
  <verify>
open_file() method uses QFileDialog.getOpenFileName
File filter shows "CSV Files (*.csv);;All Files (*)"
Import success/failure updates status bar
DriverTableView used in Race Data tab
DataController instantiated and passed to views
  </verify>
  <done>
File > Open menu triggers CSV import
Native macOS file dialog displays
CSV files load into driver table
Status bar shows import progress
Errors show user-friendly dialogs
  </done>
</task>

## Verification

After completing all tasks, verify the CSV import workflow:

1. Launch application
2. Click File > Open Data File (or press CMD+O)
3. Select a test CSV file with driver data
4. Verify native macOS file dialog appears
5. Verify data loads into table view
6. Try importing malformed CSV - verify error dialog shows
7. Verify status bar updates during import
8. Check database for saved driver data

## Success Criteria

- [ ] File > Open menu triggers native macOS file dialog
- [ ] CSV file can be selected and imported
- [ ] Imported data displays in driver table view
- [ ] Import errors show user-friendly error dialog
- [ ] Status bar shows import progress and results
- [ ] Driver table updates with imported data
- [ ] Data is saved to database for persistence

## Output

After completion, create `.planning/phases/06-foundation-gui-local-optimization/06-05-SUMMARY.md`
