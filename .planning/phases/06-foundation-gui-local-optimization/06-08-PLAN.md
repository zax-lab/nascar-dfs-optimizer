---
phase: 06-foundation-gui-local-optimization
plan: 08
type: execute
wave: 4
depends_on: ["06-05", "06-07"]
files_modified:
  - apps/native_mac/gui/controllers/data_controller.py
  - apps/native_mac/gui/views/lineups_tab.py
  - apps/native_mac/gui/views/driver_table.py
  - apps/native_mac/main.py
  - apps/native_mac/Info.plist
autonomous: true

must_haves:
  truths:
    - "User can export generated lineups to DraftKings upload CSV format"
    - "CSV export includes required DraftKings columns: Entry ID, Driver 1-6 names"
    - "User can double-click .csv files to open them in the application"
    - "File > Export menu triggers native macOS save dialog"
    - "Exported CSV passes DraftKings upload validation"
  artifacts:
    - path: "apps/native_mac/gui/controllers/data_controller.py"
      provides: "export_lineups_to_csv method for DraftKings format"
      contains: "export_lineups_to_csv"
    - path: "apps/native_mac/gui/views/lineups_tab.py"
      provides: "LineupsTab with Export button and table view"
      contains: "class LineupsTab"
    - path: "apps/native_mac/Info.plist"
      provides: "CFBundleDocumentTypes for CSV file association"
      contains: "CFBundleTypeExtensions.*csv"
  key_links:
    - from: "apps/native_mac/gui/views/lineups_tab.py"
      to: "apps/native_mac/gui/models/lineup_model.py"
      via: "LineupTableModel for lineup display"
      pattern: "from.*models.lineup_model import LineupTableModel"
    - from: "apps/native_mac/gui/views/lineups_tab.py"
      to: "apps/native_mac/gui/controllers/data_controller.py"
      via: "DataController for export"
      pattern: "from.*controllers.data_controller import DataController"
    - from: "apps/native_mac/main.py"
      to: "apps/native_mac/gui/controllers/data_controller.py"
      via: "File open event handling for CSV association"
      pattern: "eventFilter.*QEvent.FileOpen"
---

## Objective

Implement CSV export in DraftKings upload format and add file association support so users can double-click .csv files to open them in the application.

**Purpose:** After generating lineups, users need to export them in the exact format DraftKings requires for contest entry. File association provides a convenient way to open race data files directly from Finder.

**Output:** Working CSV export to DraftKings format and .csv file association with the app.

## Context

@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation-gui-local-optimization/06-RESEARCH.md
@.planning/phases/06-foundation-gui-local-optimization/06-05-SUMMARY.md
@.planning/phases/06-foundation-gui-local-optimization/06-07-SUMMARY.md

## Tasks

<task type="auto">
  <name>Add export_lineups_to_csv method to DataController</name>
  <files>apps/native_mac/gui/controllers/data_controller.py</files>
  <action>
Extend DataController with DraftKings CSV export functionality:

1. Add export_lineups_to_csv method to existing DataController:
```python
def export_lineups_to_csv(
    self,
    lineups: list[dict],
    file_path: str,
    format: str = "draftkings"  # Future: fanduel, etc.
) -> tuple[bool, str]:
    """Export lineups to CSV in DraftKings upload format.
    
    Args:
        lineups: List of lineup dicts with 'drivers' (list of names)
        file_path: Output file path
        format: Export format (default: draftkings)
    
    Returns:
        (success, error_message)
    """
```

2. DraftKings format requirements:
   - Column headers: Entry ID, Driver 1, Driver 2, Driver 3, Driver 4, Driver 5, Driver 6
   - Entry ID: sequential numbers (1, 2, 3...)
   - Driver names: must match DraftKings roster exactly
   - One lineup per row
   - UTF-8 encoding with BOM for Excel compatibility

3. Implementation:
```python
import csv

def export_lineups_to_csv(self, lineups, file_path, format="draftkings"):
    try:
        with open(file_path, 'w', newline='', encoding='utf-8-sig') as f:
            writer = csv.writer(f)
            # Header
            writer.writerow(['Entry ID', 'Driver 1', 'Driver 2', 'Driver 3', 
                           'Driver 4', 'Driver 5', 'Driver 6'])
            # Data rows
            for i, lineup in enumerate(lineups, 1):
                drivers = lineup['drivers']
                row = [i] + drivers[:6]  # Entry ID + up to 6 drivers
                writer.writerow(row)
        return True, ""
    except Exception as e:
        return False, str(e)
```

4. Add validation:
   - Verify all lineups have 6 drivers
   - Check for duplicate lineups
   - Warn if driver names might not match DraftKings roster

5. Add export_drivers_to_csv method (for saving imported data):
   - Re-importable format with all driver columns
   - Same format as import for round-trip compatibility

6. Update existing import_driver_csv to handle round-trip:
   - If CSV has 'Entry ID' column, treat as lineup export
   - If CSV has 'driver_id' column, treat as driver data

Follow research pattern from 06-RESEARCH.md > DraftKings CSV Export Format.
  </action>
  <verify>
export_lineups_to_csv method added to DataController
Method accepts lineups list and file_path
DraftKings format: Entry ID + Driver 1-6 columns
UTF-8 encoding with BOM
Validation for 6 drivers per lineup
Export drivers method for data round-trip
  </verify>
  <done>
CSV export methods added to DataController
DraftKings format implemented correctly
Validation prevents invalid exports
Round-trip import/export working
  </done>
</task>

<task type="auto">
  <name>Create LineupsTab with table view and export functionality</name>
  <files>apps/native_mac/gui/views/lineups_tab.py, apps/native_mac/gui/main_window.py</files>
  <action>
Create LineupsTab to display generated lineups with export button:

1. Create `lineups_tab.py` with LineupsTab class (subclass QWidget):

2. Tab layout:
   - Top toolbar: QHBoxLayout with buttons
     - "Export to DraftKings" button (primary action)
     - "Save Lineups" button (to database)
     - "Load Saved Lineups" dropdown (QComboBox with saved races)
   - Main area: QTableView with LineupTableModel
   - Bottom: QLabel showing lineup count and total salary stats

3. Constructor dependencies:
   - database_manager: DatabaseManager
   - data_controller: DataController
   - lineup_model: LineupTableModel
   - parent: QWidget (optional)

4. Implement on_export_draftkings() slot:
```python
def on_export_draftkings(self):
    if not self.lineup_model.rowCount():
        QMessageBox.warning(self, "No Lineups", "Generate lineups first.")
        return

    file_path, _ = QFileDialog.getSaveFileName(
        self,
        "Export Lineups for DraftKings",
        "lineups.csv",
        "CSV Files (*.csv);;All Files (*)"
    )
    if not file_path:
        return

    # Get lineups from model
    lineups = self.lineup_model.get_all_lineups()
    
    success, error = self.data_controller.export_lineups_to_csv(
        lineups, file_path, format="draftkings"
    )
    
    if success:
        QMessageBox.information(
            self, "Export Complete", 
            f"Exported {len(lineups)} lineups to {file_path}"
        )
    else:
        QMessageBox.critical(self, "Export Error", error)
```

5. Implement on_save_lineups() slot:
   - Save current lineups to database via DatabaseManager
   - Associate with current race_id
   - Update "Load Saved Lineups" dropdown

6. Table view configuration:
   - Sorting enabled (click headers to sort by projected points)
   - Selection: single row (click to view details)
   - Column widths: auto-resize to content

7. Update main_window.py create_lineups_tab():
   - Replace placeholder with real LineupsTab
   - Pass required dependencies
   - Connect signals for model updates

Follow research pattern from 06-RESEARCH.md > Lineup Display and Export.
  </action>
  <verify>
LineupsTab subclasses QWidget
Export to DraftKings button triggers QFileDialog.getSaveFileName
LineupTableModel integrated with QTableView
Save/Load lineups buttons functional
Table sorting enabled
Export validates lineups exist before proceeding
  </verify>
  <done>
LineupsTab created with lineup table view
Export to DraftKings functional
Save/Load lineups to database working
Table sorting and selection working
  </done>
</task>

<task type="auto">
  <name>Implement CSV file association for double-click to open</name>
  <files>apps/native_mac/main.py, apps/native_mac/Info.plist</files>
  <action>
Add file association support so .csv files open in the app when double-clicked:

1. Update main.py to handle file open events:
```python
class MainApplication(QApplication):
    """Custom QApplication that handles file open events."""
    
    fileOpened = Signal(str)  # Emitted when CSV file opened
    
    def event(self, event):
        if event.type() == QEvent.FileOpen:
            file_path = event.file()
            if file_path.endswith('.csv'):
                self.fileOpened.emit(file_path)
                return True
        return super().event(event)
```

2. Update main() function:
```python
def main():
    app = MainApplication(sys.argv)
    app.setApplicationName("NASCAR DFS Optimizer")
    
    # ... create main window ...
    
    # Connect file open signal
    app.fileOpened.connect(main_window.on_file_opened)
    
    return app.exec()
```

3. Add on_file_opened handler to MainWindow:
```python
def on_file_opened(self, file_path: str):
    """Handle CSV file opened via double-click or drag-drop."""
    # Switch to Race Data tab
    self.tab_widget.setCurrentIndex(0)
    # Trigger import
    self.driver_table.load_drivers_from_csv(file_path)
    self.status_bar.showMessage(f"Opened {file_path}", 3000)
```

4. Create Info.plist for file association (used by py2app):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN">
<plist version="1.0">
<dict>
    <key>CFBundleDocumentTypes</key>
    <array>
        <dict>
            <key>CFBundleTypeName</key>
            <string>CSV Document</string>
            <key>CFBundleTypeExtensions</key>
            <array>
                <string>csv</string>
            </array>
            <key>CFBundleTypeRole</key>
            <string>Editor</string>
            <key>LSHandlerRank</key>
            <string>Alternate</string>
        </dict>
    </array>
</dict>
</plist>
```

5. Update setup.py to include Info.plist:
```python
setup(
    app=['main.py'],
    options={
        'py2app': {
            'plist': 'Info.plist',
            # ... other options
        }
    }
)
```

6. Add drag-and-drop support to DriverTableView:
   - Enable setAcceptDrops(True)
   - Implement dragEnterEvent and dropEvent
   - Accept drops of .csv files

Follow research pattern from 06-RESEARCH.md > macOS File Association.
  </action>
  <verify>
MainApplication subclass handles QEvent.FileOpen
fileOpened signal emitted when CSV opened
MainWindow.on_file_opened imports the CSV file
Info.plist defines CFBundleDocumentTypes for CSV
Drag-and-drop of CSV files works
File association registered with macOS
  </verify>
  <done>
CSV file association implemented
Double-click CSV opens in application
Drag-and-drop CSV import working
Info.plist configured for file types
  </done>
</task>

## Verification

After completing all tasks, verify CSV export and file association:

1. Generate lineups in Optimization tab
2. Navigate to Lineups tab
3. Click "Export to DraftKings" button
4. Verify native save dialog appears
5. Save file and verify format:
   - Headers: Entry ID, Driver 1-6
   - One row per lineup
   - UTF-8 encoding with BOM
6. Test file association:
   - Create test.csv with sample driver data
   - Double-click in Finder - should open in NASCAR DFS Optimizer
   - Verify data imports automatically
7. Test drag-and-drop:
   - Drag CSV file onto application window
   - Verify import triggers

## Success Criteria

- [ ] Export to DraftKings button in Lineups tab
- [ ] CSV export has correct DraftKings format (Entry ID + 6 drivers)
- [ ] Native save dialog for choosing export location
- [ ] Double-clicking .csv files opens them in app
- [ ] Drag-and-drop of CSV files triggers import
- [ ] Info.plist defines CSV file association
- [ ] Export validation ensures 6 drivers per lineup

## Output

After completion, create `.planning/phases/06-foundation-gui-local-optimization/06-08-SUMMARY.md`
