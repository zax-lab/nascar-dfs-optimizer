---
phase: 06-foundation-gui-local-optimization
plan: 10
type: execute
wave: 5
depends_on: ["06-01", "06-02", "06-04", "06-07", "06-09"]
files_modified:
  - apps/native_mac/main.py
  - apps/native_mac/gui/main_window.py
  - apps/native_mac/session_restorer.py
  - apps/native_mac/gui/views/settings_tab.py
autonomous: true

must_haves:
  truths:
    - "User quits app and relaunches to find previous session restored"
    - "Window geometry (position, size, maximized state) is restored"
    - "Last viewed race is automatically loaded on startup"
    - "Generated lineups from previous session are available in Lineups tab"
    - "Settings tab allows configuring session restore behavior"
    - "User can disable session restore in Settings"
  artifacts:
    - path: "apps/native_mac/session_restorer.py"
      provides: "SessionRestorer for orchestrating session restore on launch"
      contains: "class SessionRestorer"
    - path: "apps/native_mac/gui/views/settings_tab.py"
      provides: "SettingsTab with session restore preferences"
      contains: "class SettingsTab"
  key_links:
    - from: "apps/native_mac/session_restorer.py"
      to: "apps/native_mac/persistence/session_manager.py"
      via: "SessionManager for loading saved state"
      pattern: "from.*persistence.session_manager import SessionManager"
    - from: "apps/native_mac/main.py"
      to: "apps/native_mac/session_restorer.py"
      via: "Session restoration on app launch"
      pattern: "from.*session_restorer import SessionRestorer"
    - from: "apps/native_mac/gui/views/settings_tab.py"
      to: "apps/native_mac/persistence/session_manager.py"
      via: "Save/restore settings preferences"
      pattern: "from.*persistence.session_manager import SessionManager"
---

## Objective

Implement session resume functionality that restores the previous application state on launch, including window geometry, last viewed race, and generated lineups. Also create the Settings tab for configuring application preferences.

**Purpose:** Desktop applications are expected to restore the user's previous session on relaunch. This includes window position, open data, and generated results. Users should also have a Settings tab to configure preferences like session restore behavior.

**Output:** Working session restore on app launch and functional Settings tab with preferences.

## Context

@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation-gui-local-optimization/06-RESEARCH.md
@.planning/phases/06-foundation-gui-local-optimization/06-01-SUMMARY.md
@.planning/phases/06-foundation-gui-local-optimization/06-02-SUMMARY.md
@.planning/phases/06-foundation-gui-local-optimization/06-07-SUMMARY.md
@.planning/phases/06-foundation-gui-local-optimization/06-09-SUMMARY.md

## Tasks

<task type="auto">
  <name>Create SessionRestorer for orchestrating session restore</name>
  <files>apps/native_mac/session_restorer.py, apps/native_mac/main.py</files>
  <action>
Create SessionRestorer class to restore application state on launch:

1. Create `session_restorer.py` with SessionRestorer class:

2. Constructor dependencies:
   - session_manager: SessionManager
   - database_manager: DatabaseManager
   - main_window: MainWindow (set after window creation)

3. Implement restore_session() method:
```python
def restore_session(self) -> bool:
    """Restore previous session on app launch.
    
    Returns:
        True if session was restored, False if no saved state or disabled.
    """
    # Check if session restore is enabled
    if not self._is_restore_enabled():
        return False
    
    # Restore window geometry (already done in MainWindow.__init__)
    
    # Restore last viewed race
    last_race = self.session_manager.load_last_race()
    if last_race:
        self._restore_race(last_race)
    
    # Restore generated lineups for last race
    if last_race:
        lineups = self.optimization_engine.load_results(last_race['id'])
        if lineups:
            self._restore_lineups(lineups)
    
    # Restore active tab
    active_tab = self.session_manager.load_state('active_tab', 0)
    if self.main_window:
        self.main_window.tab_widget.setCurrentIndex(active_tab)
    
    return True
```

4. Implement _restore_race():
   - Load race data from database
   - Load driver data for the race
   - Update DriverTableModel with drivers
   - Update Race selector in OptimizationTab

5. Implement _restore_lineups():
   - Load lineups from database
   - Update LineupTableModel
   - Switch to Lineups tab if lineups exist

6. Update main.py to use SessionRestorer:
```python
def main():
    # ... app setup ...
    
    # Create main window
    main_window = MainWindow(...)
    
    # Restore session
    restorer = SessionRestorer(session_manager, database_manager)
    restorer.set_main_window(main_window)
    restorer.restore_session()
    
    main_window.show()
    return app.exec()
```

7. Implement _is_restore_enabled():
   - Check app_state for 'session_restore_enabled' key
   - Default to True if not set
   - Can be disabled in Settings

Follow research pattern from 06-RESEARCH.md > Session Restore Pattern.
  </action>
  <verify>
SessionRestorer class created
restore_session method orchestrates state restoration
_is_restore_enabled checks user preference
_restore_race loads and displays previous race data
_restore_lineups loads previous optimization results
main.py calls restore_session after window creation
  </verify>
  <done>
SessionRestorer created with full restore logic
Window geometry, race data, lineups restored
Restore can be disabled via settings
main.py integration complete
  </done>
</task>

<task type="auto">
  <name>Create SettingsTab with session restore and preferences</name>
  <files>apps/native_mac/gui/views/settings_tab.py, apps/native_mac/gui/main_window.py</files>
  <action>
Create SettingsTab for application preferences:

1. Create `settings_tab.py` with SettingsTab class (subclass QWidget):

2. Settings categories with QGroupBox:
   
   a) Session & Startup:
   - QCheckBox: "Restore previous session on launch" (default checked)
   - QCheckBox: "Load last race automatically" (default checked)
   - QCheckBox: "Remember window position and size" (default checked)
   
   b) Optimization:
   - QSpinBox: "Default lineup count" (range 10-150, default 20)
   - QSpinBox: "Default MCMC iterations" (range 100-5000, default 1000)
   - QDoubleSpinBox: "Default max ownership" (range 0-100, default 50%)
   
   c) Appearance:
   - QComboBox: "Theme" (options: "System", "Light", "Dark")
   - QCheckBox: "Show alternating row colors in tables" (default checked)
   
   d) Data Management:
   - QPushButton: "Clear Race History" - clears all races from database
   - QPushButton: "Clear Saved Lineups" - clears all lineups
   - QPushButton: "Export Database" - backup database to file
   - QPushButton: "Reset All Settings" - restores defaults

3. Constructor dependencies:
   - session_manager: SessionManager
   - database_manager: DatabaseManager
   - parent: QWidget (optional)

4. Implement load_settings():
   - Read all preferences from app_state table
   - Update UI widgets to match saved values
   - Use defaults if no saved preferences

5. Implement save_settings():
   - Read values from UI widgets
   - Save to app_state table via SessionManager
   - Apply settings immediately where possible

6. Implement reset_settings():
   - Clear all app_state entries
   - Reload UI with defaults
   - Show confirmation dialog

7. Update main_window.py create_settings_tab():
   - Replace placeholder with real SettingsTab
   - Pass SessionManager and DatabaseManager
   - Connect settings_changed signal for theme updates

Follow research pattern from 06-RESEARCH.md > Settings Tab Pattern.
  </action>
  <verify>
SettingsTab subclasses QWidget
Session & Startup group with restore checkboxes
Optimization group with defaults
Appearance group with theme selector
Data Management group with action buttons
load_settings reads from database
save_settings writes to database
reset_settings restores defaults
  </verify>
  <done>
SettingsTab created with all preference groups
Session restore settings functional
Optimization defaults configurable
Theme switching working
Data management actions functional
  </done>
</task>

<task type="auto">
  <name>Integrate session save on app quit and tab change</name>
  <files>apps/native_mac/gui/main_window.py, apps/native_mac/persistence/session_manager.py</files>
  <action>
Enhance MainWindow and SessionManager to save session state:

1. Update MainWindow.closeEvent to save session:
```python
def closeEvent(self, event):
    """Save session state before closing."""
    # Save window geometry
    if self.session_manager:
        self.session_manager.save_window_geometry(self)
    
    # Save current race
    if self.current_race_id and self.session_manager:
        race_info = self.get_current_race_info()
        self.session_manager.save_last_race(
            self.current_race_id, 
            race_info['track_name']
        )
    
    # Save active tab
    if self.session_manager:
        self.session_manager.save_state(
            'active_tab', 
            self.tab_widget.currentIndex()
        )
    
    event.accept()
```

2. Update MainWindow to track current race:
   - Add self.current_race_id attribute
   - Update when race is loaded or created
   - Update when optimization is run

3. Add get_current_race_info() method:
```python
def get_current_race_info(self) -> dict:
    """Get information about current race for session save."""
    if self.current_race_id:
        return self.database_manager.get_race(self.current_race_id)
    return None
```

4. Enhance SessionManager with convenience methods:
```python
def save_last_race(self, race_id: int, track_name: str):
    """Save last viewed race for session restore."""
    self.save_state('last_race_id', race_id)
    self.save_state('last_race_track', track_name)
    self.save_state('last_race_timestamp', datetime.now().isoformat())

def load_last_race(self) -> dict:
    """Load last viewed race info."""
    race_id = self.load_state('last_race_id')
    if race_id:
        return {
            'id': race_id,
            'track_name': self.load_state('last_race_track', 'Unknown'),
            'timestamp': self.load_state('last_race_timestamp')
        }
    return None
```

5. Save race when optimization completes:
   - In OptimizationTab, save race_id when lineups are generated
   - This ensures race is restored even if user didn't manually save

6. Add periodic auto-save (optional):
   - QTimer that saves session every 60 seconds
   - Prevents data loss on crash
   - Disabled during optimization to avoid interference

7. Test scenarios:
   - User imports race, generates lineups, quits
   - Relaunch - verify race and lineups restored
   - User disables session restore - verify clean start
   - User clears race history - verify no restore

Follow research pattern from 06-RESEARCH.md > Session Save Pattern.
  </action>
  <verify>
closeEvent saves window geometry, last race, active tab
current_race_id tracked in MainWindow
get_current_race_info retrieves race details
SessionManager.save_last_race and load_last_race working
Race saved when optimization completes
Session restored correctly on relaunch
  </verify>
  <done>
Session save integrated into closeEvent
Current race tracking implemented
Race saved on optimization completion
Full session restore cycle working
  </done>
</task>

## Verification

After completing all tasks, verify session restore:

1. Session restore enabled (default):
   - Launch app, import race data
   - Generate lineups
   - Resize and move window
   - Switch to Lineups tab
   - Quit app (CMD+Q)
   - Relaunch app
   - Verify: window geometry restored, race loaded, lineups displayed, active tab is Lineups

2. Session restore disabled:
   - Open Settings tab
   - Uncheck "Restore previous session on launch"
   - Quit and relaunch
   - Verify: clean start with no race loaded, default window size

3. Clear race history:
   - Settings → Data Management → Clear Race History
   - Verify confirmation dialog
   - Quit and relaunch
   - Verify: no race restored

4. Settings persistence:
   - Change optimization defaults in Settings
   - Quit and relaunch
   - Verify: settings restored correctly

## Success Criteria

- [ ] Session restores window geometry on launch
- [ ] Session restores last viewed race automatically
- [ ] Session restores generated lineups
- [ ] Session restores active tab
- [ ] Settings tab allows disabling session restore
- [ ] Settings tab has optimization defaults
- [ ] Settings tab has theme selector
- [ ] Data management buttons work (clear history, export database)
- [ ] Settings persist across app launches
- [ ] Session save happens on quit and optimization completion

## Output

After completion, create `.planning/phases/06-foundation-gui-local-optimization/06-10-SUMMARY.md`

Also create final phase summary: `.planning/phases/06-foundation-gui-local-optimization/06-SUMMARY.md`
