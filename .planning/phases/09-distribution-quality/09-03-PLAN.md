---
phase: 09-distribution-quality
plan: 03
type: execute
wave: 2
depends_on: [09-01, 09-02]
files_modified:
  - dist/NASCAR-DFS-Optimizer-1.2.0.zip
autonomous: false

user_setup:
  - service: clean_macos_machine
    why: "Test app bundle on fresh macOS installation without dev tools"
    manual_steps:
      - "Copy signed .app bundle from dist/ to clean machine"
      - "Launch app and test full workflow (import ‚Üí optimize ‚Üí export)"
      - "Report any issues found during testing"

must_haves:
  truths:
    - "App launches on clean macOS machine without crashing"
    - "User can import CSV race data via File ‚Üí Open"
    - "User can set constraints and run optimization successfully"
    - "User can export lineups to DraftKings format"
    - "App persists settings across restarts"
    - "User sees Gatekeeper warning on first launch and follows workaround"
  artifacts:
    - path: "dist/NASCAR-DFS-Optimizer-1.2.0.zip"
      provides: "Distributable zip archive of signed .app bundle"
      min_lines: 1
  key_links:
    - from: "dist/NASCAR-DFS-Optimizer-1.2.0.zip"
      to: "GitHub Releases"
      via: "Release asset upload"
    - from: "Clean machine test"
      to: "Gatekeeper workaround"
      via: "Verification that control-click ‚Üí Open works"
---

<objective>
Test .app bundle on clean macOS machine and prepare zip archive for GitHub distribution.

Purpose: Verify app works on fresh macOS installation without dev tools (real user scenario). Catch missing dependencies, Gatekeeper issues, or UI bugs before public release.

Output: Clean machine test results (passed/failed), zip archive for distribution, and GitHub release notes.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-distribution-quality/09-CONTEXT.md
@.planning/phases/09-distribution-quality/09-RESEARCH.md
@.planning/phases/09-distribution-quality/09-02-PLAN.md
@CHANGELOG.md
@README.md
@INSTALL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create zip archive of signed .app bundle for distribution</name>
  <files>dist/NASCAR-DFS-Optimizer-1.2.0.zip</files>
  <action>
After successful build from Plan 09-01:

1. Navigate to apps/native_mac/dist directory:
   ```bash
   cd apps/native_mac/dist
   ```

2. Create zip archive of .app bundle:
   ```bash
   zip -r NASCAR-DFS-Optimizer-1.2.0.zip "NASCAR DFS Optimizer.app"
   ```

3. Verify zip contents:
   ```bash
   unzip -l NASCAR-DFS-Optimizer-1.2.0.zip
   ```

4. Check zip file size (should be <200MB for universal binary with all dependencies)

Zip archive preserves file attributes and is standard macOS distribution format. Do NOT use dmg (larger and unnecessary for personal distribution).
</action>
  <verify>
test -f apps/native_mac/dist/NASCAR-DFS-Optimizer-1.2.0.zip && unzip -l apps/native_mac/dist/NASCAR-DFS-Optimizer-1.2.0.zip | grep "NASCAR DFS Optimizer.app/"
</verify>
  <done>
Zip archive created at apps/native_mac/dist/NASCAR-DFS-Optimizer-1.2.0.zip containing signed .app bundle
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Signed .app bundle (from 09-01) and distribution documentation (from 09-02)</what-built>
  <how-to-verify>
Test the .app bundle on a clean macOS machine (no Python dev tools, no Neo4j installed):

**Setup:**
1. Transfer `dist/NASCAR-DFS-Optimizer-1.2.0.zip` to clean macOS machine
2. Extract zip file to get `NASCAR DFS Optimizer.app`
3. Drag app to `/Applications` folder

**Test Workflow:**

1. **First Launch & Gatekeeper:**
   - Double-click app to launch
   - Expected: Gatekeeper warning "app is damaged and can't be opened"
   - Control-click app ‚Üí Select "Open" ‚Üí Click "Open" in dialog
   - Expected: App launches successfully

2. **CSV Import Test:**
   - Go to File ‚Üí Open
   - Select sample CSV file (prepare test CSV with Driver, Salary, Team, Position columns)
   - Expected: CSV loads into Race Data table
   - Expected: Driver count and salary summary displays correctly

3. **Neo4j Connection:**
   - Go to Settings ‚Üí Neo4j Connection
   - Expected: Connection form appears with URI, Username, Password fields
   - (Optional) If Neo4j not running, test error handling: Attempt to connect
   - Expected: Clear error message "Connection refused: Is Neo4j running?"

4. **Optimization Test:**
   - Switch to Optimization tab
   - Set constraints: Salary cap $50,000, 10 lineups, 1000 iterations
   - Click "Run Optimization"
   - Expected: Progress dialog shows optimization progress
   - Expected: Completes in 30-60 seconds (or faster with GPU)
   - Expected: Results appear in Lineups tab

5. **Lineup Export Test:**
   - Switch to Lineups tab
   - Verify lineups displayed with driver names and salaries
   - Click "Export to DraftKings"
   - Save CSV file
   - Expected: CSV has Entry ID, Driver 1-6 columns (DraftKings format)
   - Expected: CSV opens in Excel correctly (UTF-8 with BOM)

6. **Settings Persistence Test:**
   - Change window size and position
   - Quit app (CMD+Q)
   - Relaunch app
   - Expected: Window size and position restored
   - Verify in Settings tab: Last race, constraint settings saved

7. **Keyboard Shortcuts Test:**
   - Press CMD+O to open file dialog
   - Press CMD+Z to undo last action
   - Press CMD+W to close active tab
   - Expected: All shortcuts work as documented

8. **Dock & Notifications Test:**
   - Start optimization job
   - Expected: Dock icon bounces on completion
   - Expected: macOS notification appears with "View Lineups" action
   - Click "View Lineups" in notification
   - Expected: App switches to Lineups tab

**Failure Criteria:**
- App crashes on launch (check Console.app for crash logs)
- CSV import fails or displays malformed data
- Optimization hangs indefinitely (>2 minutes) or crashes
- Exported CSV is invalid (wrong columns, garbled text)
- Settings not persisting
- Gatekeeper workaround does not work (app cannot be opened)
- Keyboard shortcuts not working

**If Any Failure Occurs:**
- Note the exact issue and error messages
- Check TROUBLESHOOTING.md for known solutions
- Report issue with reproduction steps for Plan 09-01 or 09-02 to address
</how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe failures to address</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Prepare GitHub release notes and upload instructions</name>
  <files>dist/RELEASE_NOTES.md</files>
  <action>
Create dist/RELEASE_NOTES.md with GitHub release content:

```markdown
# NASCAR DFS Optimizer v1.2.0

Native macOS application for DraftKings NASCAR DFS optimization with physics-compliant constraints and MCMC sampling.

## üì• Download

**NASCAR-DFS-Optimizer-1.2.0.zip** (Universal Binary - Apple Silicon + Intel)

## üöÄ Quick Start

1. Extract zip file and drag `NASCAR DFS Optimizer.app` to `/Applications`
2. Launch app (Control-click ‚Üí Open on first launch to bypass Gatekeeper)
3. Import race data: File ‚Üí Open (CSV format)
4. Set constraints and run optimization
5. Export lineups: Lineups tab ‚Üí Export to DraftKings

## ‚öôÔ∏è Requirements

- macOS 12.0 (Monterey) or later
- Apple Silicon (M1/M2/M3) or Intel Mac
- 4GB RAM minimum, 8GB recommended
- Neo4j 5.x or 4.x database (for constraint ontology)

## üìö Documentation

- [Installation Guide](../INSTALL.md) - Step-by-step setup with Neo4j instructions
- [Troubleshooting](../TROUBLESHOOTING.md) - Common issues and solutions
- [Changelog](../CHANGELOG.md) - Version history

## ‚ú® Features

### Native macOS GUI
- Tabbed interface: Race Data, Optimization, Lineups, Jobs, Settings
- Dark mode support (follows system appearance)
- Native keyboard shortcuts (CMD+Z, CMD+O, CMD+W, etc.)
- Dock icon with bounce notifications on optimization completion
- macOS notifications with "View Lineups" action button

### Optimization Engine
- JAX-based MCMC sampling (Apple Silicon optimized)
- Physics-compliant constraints via Neo4j ontology
- Portfolio optimization with tail metrics (1%, 5%, 10% quantiles)
- Optional Windows GPU offload for heavy jobs

### Workflow Features
- CSV import/export for race data and DraftKings lineup uploads
- Constraint presets (save/load optimization configurations)
- Undo/Redo system with unlimited depth
- Keyboard shortcuts with full customization
- Split-view editor for real-time optimization preview
- Background job queue with dock badge status

### Data Management
- SQLite local persistence (races, lineups, jobs)
- Settings backup/export to JSON
- Session restore (window geometry, last race, lineups)
- File associations (double-click CSV to open in app)

## üîß Neo4j Setup

The app requires Neo4j database for constraint ontology. See [INSTALL.md](../INSTALL.md) for setup:

**Docker (Recommended):**
\`\`\`bash
docker run -d --name neo4j -p 7474:7474 -p 7687:7687 -e NEO4J_AUTH=neo4j/yourpassword neo4j:5.15
\`\`\`

**Configure App:** Settings ‚Üí Neo4j Connection ‚Üí Enter bolt://localhost:7687 credentials

## ‚ö†Ô∏è Gatekeeper (First Launch)

On first launch, macOS may show a security warning:
> "NASCAR DFS Optimizer.app is damaged and can't be opened"

**Solution:** Right-click (Control-click) app ‚Üí Select "Open" ‚Üí Click "Open" in dialog

You only need to do this once. The app will launch normally afterward.

## üêõ Known Issues

- Optimization takes 30-60 seconds on local CPU (normal for MCMC sampling)
- Use GPU offload for faster optimization (requires Windows GPU worker)
- App requires Neo4j server running (cannot start without it)
- JAX dependencies included in bundle; if optimization fails, check Console.app for import errors

## üìÑ License

Personal use project. See [LICENSE](../LICENSE) for details.

## ü§ù Support

- Report issues on [GitHub Issues](https://github.com/your-repo/issues)
- Check [Troubleshooting Guide](../TROUBLESHOOTING.md) for common issues
- View Console.app logs for crash reports

---

**Release Date:** 2026-01-30
**Version:** 1.2.0
**Architecture:** Universal Binary (arm64 + x86_64)
```

This file provides content for GitHub release body when creating release via GitHub web UI or `gh release create` CLI.
</action>
  <verify>
test -f dist/RELEASE_NOTES.md && grep -q "Quick Start" dist/RELEASE_NOTES.md && grep -q "Gatekeeper" dist/RELEASE_NOTES.md
</verify>
  <done>
RELEASE_NOTES.md created with comprehensive GitHub release content including download instructions, requirements, and troubleshooting links
</done>
</task>

</tasks>

<verification>
After all tasks complete:
- Zip archive created at apps/native_mac/dist/NASCAR-DFS-Optimizer-1.2.0.zip
- Clean machine test passed (user verified full workflow)
- RELEASE_NOTES.md provides GitHub release content
- Release notes link to INSTALL.md and TROUBLESHOOTING.md
</verification>

<success_criteria>
.zip archive ready for GitHub release, app tested on clean macOS machine, release notes prepared
</success_criteria>

<output>
After completion, create `.planning/phases/09-distribution-quality/09-03-SUMMARY.md`
</output>
