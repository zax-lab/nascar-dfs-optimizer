---
phase: 09-distribution-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/native_mac/setup.py
  - apps/native_mac/version.py
  - scripts/build.sh
  - CHANGELOG.md
autonomous: true

must_haves:
  truths:
    - "Developer runs build script and receives signed .app bundle in dist/"
    - "Build script cleans previous build artifacts before building"
    - "Build script verifies bundle creation and signature validity"
    - "App bundle includes all dependencies (PySide6, JAX, Neo4j, pandas, numpy)"
    - "CHANGELOG.md documents all v1.2.0 features and changes"
    - "App bundle signed with ad-hoc signature for personal distribution (or personal Apple ID if Developer Program available)"
  artifacts:
    - path: "scripts/build.sh"
      provides: "Build automation script with error handling and verification"
      min_lines: 30
    - path: "apps/native_mac/setup.py"
      provides: "py2app configuration with explicit dependencies"
      contains: "packages: [PySide6, jax, jaxlib, neo4j, pandas, numpy]"
    - path: "apps/native_mac/version.py"
      provides: "Version constant synchronized with setup.py and CHANGELOG.md"
      contains: "VERSION = \"1.2.0\""
    - path: "CHANGELOG.md"
      provides: "Version history and release notes"
      contains: "## [1.2.0] - 2026-01-30"
  key_links:
    - from: "scripts/build.sh"
      to: "apps/native_mac/setup.py"
      via: "python setup.py py2app invocation"
    - from: "scripts/build.sh"
      to: "dist/NASCAR-DFS-Optimizer.app"
      via: "build output verification and code signing"
    - from: "CHANGELOG.md"
      to: "apps/native_mac/version.py"
      via: "version synchronization (1.2.0)"
---

<objective>
Create reproducible build automation with code signing and document v1.2.0 release history in CHANGELOG.

Purpose: Ensure app bundle can be built consistently with clean state, properly signed for Gatekeeper, and all releases are documented in changelog for users to track changes.

Output: Build script (scripts/build.sh), updated setup.py with comprehensive dependencies, and CHANGELOG.md with v1.2.0 release notes.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-distribution-quality/09-CONTEXT.md
@.planning/phases/09-distribution-quality/09-RESEARCH.md
@apps/native_mac/setup.py
@.planning/phases/06-foundation-gui-local-optimization/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build script with clean build, py2app build, and code signing</name>
  <files>scripts/build.sh</files>
  <action>
Create scripts/build.sh with the following structure:
1. Shebang: #!/usr/bin/env bash
2. set -e for error handling (exit on error)
3. Change to apps/native_mac directory
4. Clean previous builds: rm -rf build dist
5. Run py2app build: python setup.py py2app
6. Verify .app bundle was created (check dist/NASCAR DFS Optimizer.app exists)
7. Sign bundle (choose one method):
   a) Ad-hoc signing (personal distribution, no cost):
      codesign --force --deep --sign - dist/NASCAR\ DFS\ Optimizer.app
   b) Personal Apple ID signing (requires Developer Program):
      codesign --force --deep --sign - dist/NASCAR\ DFS\ Optimizer.app
      # Or with explicit identity:
      # codesign --force --deep --sign "Developer ID Application: Your Name" dist/NASCAR\ DFS\ Optimizer.app
8. Verify signature: codesign -dv dist/NASCAR\ DFS\ Optimizer.app
9. Print success message with bundle path

Make script executable (chmod +x scripts/build.sh).

Do NOT use --argv_emulation (conflicts with PySide6 event loop).

**Signing Options:**
- **Ad-hoc signing** (default): Use sign - . Works for personal distribution, no Apple Developer Program required. Users will see Gatekeeper warning on first launch (documented in INSTALL.md).
- **Personal Apple ID**: If you have Apple Developer Program membership, replace - with "Developer ID Application: Your Name" to reduce Gatekeeper warnings for distributed apps.

Error handling: If build fails or bundle not created, exit with error code 1 and print descriptive message.
</action>
  <verify>
chmod +x scripts/build.sh && cd apps/native_mac && ../../scripts/build.sh
</verify>
  <done>
Build script creates signed .app bundle at apps/native_mac/dist/NASCAR DFS Optimizer.app with valid signature verified by codesign (ad-hoc or personal Apple ID)
</done>
</task>

<task type="auto">
  <name>Task 2: Update setup.py with explicit dependencies and verify compatibility</name>
  <files>apps/native_mac/setup.py</files>
  <action>
Review and update apps/native_mac/setup.py to ensure:
1. OPTIONS["packages"] includes all runtime dependencies:
   - PySide6, PySide6.QtCore, PySide6.QtWidgets, PySide6.QtGui
   - pandas, numpy
   - jax, jaxlib (for optimization engine)
   - neo4j (for constraint ontology)
2. OPTIONS["includes"] lists PySide6 submodules that py2app might miss
3. OPTIONS["excludes"] removes pytest, setuptools (dev dependencies)
4. OPTIONS["arch"] is "universal2" for Apple Silicon + Intel compatibility
5. OPTIONS["qt_plugins"] includes "imageformats" for screenshot/icon loading
6. CFBundleVersion and CFBundleShortVersionString are "1.2.0"
7. NSHighResolutionCapable is True
8. NSRequiresAquaSystemAppearance is False (dark mode support)

9. **Version synchronization:** Update apps/native_mac/version.py to ensure VERSION = "1.2.0":
   - Create or edit apps/native_mac/version.py
   - Set VERSION = "1.2.0"
   - Ensure this matches CFBundleVersion/CFBundleShortVersionString in setup.py and CHANGELOG.md

If any packages are missing from OPTIONS["packages"], add them explicitly. Do NOT use setup_requires (deprecated).

Reference: RESEARCH.md Pattern 1 for py2app setup configuration.
</action>
  <verify>
grep -q '"jax"' apps/native_mac/setup.py && grep -q '"neo4j"' apps/native_mac/setup.py && grep -q '"universal2"' apps/native_mac/setup.py && grep -q 'VERSION.*1.2.0' apps/native_mac/version.py
</verify>
  <done>
setup.py explicitly lists all runtime dependencies (PySide6, JAX, Neo4j, pandas, numpy) with universal2 architecture and dark mode support. version.py synchronized to 1.2.0.
</done>
</task>

<task type="auto">
  <name>Task 3: Create CHANGELOG.md with v1.2.0 release notes</name>
  <files>CHANGELOG.md</files>
  <action>
Create CHANGELOG.md in project root with:
1. Header: # Changelog
2. Version 1.2.0 entry:
   - ## [1.2.0] - 2026-01-30
   - ### Added
     - Native macOS GUI with PySide6/Qt6
     - Tabbed interface: Race Data, Optimization, Lineups, Jobs, Settings
     - CSV import/export for race data and DraftKings lineup uploads
     - Local JAX-based MCMC optimization engine
     - Constraint presets system for saving/loading constraint configurations
     - Undo/Redo system with CMD+Z / CMD+Shift+Z shortcuts
     - Keyboard shortcuts with configurable customization
     - Split-view editor for real-time optimization preview
     - Background job queue with dock badge and menubar status
     - Optional Windows GPU offload for heavy optimization jobs
     - Settings backup/export to JSON for data portability
     - Kernel veto log viewer for debugging constraint rejections
   - ### Fixed
     - py2app setup.py compatibility (removed deprecated setup_requires)
   - ### Technical
     - SQLite local persistence for races, lineups, jobs
     - Neo4j driver for constraint ontology (server required)
     - Universal binary support (Apple Silicon + Intel)
3. Add placeholder for future versions:
   - ## [Unreleased]

Reference: RESEARCH.md GitHub Release example for formatting.
</action>
  <verify>
grep -q "## \[1.2.0\]" CHANGELOG.md && grep -q "Native macOS GUI" CHANGELOG.md && grep -q "Universal binary" CHANGELOG.md
</verify>
  <done>
CHANGELOG.md created with v1.2.0 release notes documenting all features from Phase 6-8
</done>
</task>

</tasks>

<verification>
After all tasks complete:
- Build script exists and is executable
- Running build script creates .app bundle without errors
- codesign -dv confirms valid signature
- CHANGELOG.md documents v1.2.0 features comprehensively
</verification>

<success_criteria>
Developer can run ./scripts/build.sh to generate reproducible, signed .app bundle at apps/native_mac/dist/NASCAR DFS Optimizer.app
</success_criteria>

<output>
After completion, create `.planning/phases/09-distribution-quality/09-01-SUMMARY.md`
</output>
