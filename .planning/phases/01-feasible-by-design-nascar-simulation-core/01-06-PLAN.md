---
phase: 01-feasible-by-design-nascar-simulation-core
plan: 06
type: execute
wave: 5
depends_on: ["01-03", "01-05"]
files_modified:
  - packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py
  - packages/axiomatic-sim/tests/test_scenario_generator_integration.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Scenario generator calls CBN.sample_outcomes() to generate driver outcomes conditioned on race-flow regime"
    - "Driver outcomes sampled from CBN reflect causal relationships (skill → laps_led, aggression → incidents)"
    - "Simplified outcome generation replaced with CBN-conditioned sampling"
    - "Hybrid granularity simulation uses CBN sampling for fine-granularity segments"
  artifacts:
    - path: "packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py"
      provides: "Scenario generator using CBN-conditioned outcome sampling"
      min_lines: 500
      exports: ["SkeletonNarrative.generate_single_scenario"]
    - path: "packages/axiomatic-sim/tests/test_scenario_generator_integration.py"
      provides: "Integration tests verifying CBN sampling in scenario generation"
      min_lines: 100
  key_links:
    - from: "packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py"
      to: "packages/axiomatic-sim/src/axiomatic_sim/cbn.py"
      via: "Call cbn.sample_outcomes() with evidence from race-flow regime"
      pattern: "self\.cbn\.sample_outcomes\(.*evidence="
    - from: "packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py"
      to: "packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py"
      via: "generate_single_scenario uses CBN samples instead of simplified outcome generation"
      pattern: "cbn\.sample_outcomes\(" not in comment
---

<objective>
Integrate CBN outcome sampling into scenario generation pipeline, replacing simplified outcome generation with CBN-conditioned sampling.

Purpose: Complete the causal modeling infrastructure by wiring CBN into scenario generation. Driver outcomes now reflect learned causal relationships (e.g., high-skill drivers in high-caution regimes lead different lap counts than low-skill drivers).

Output: Scenario generator calling CBN.sample_outcomes() with race-flow regime evidence, tests verifying causal outcomes, kernel conservation validation still working
</objective>

<execution_context>
@/Users/zax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zax/.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-feasible-by-design-nascar-simulation-core/01-CONTEXT.md
@.planning/phases/01-feasible-by-design-nascar-simulation-core/01-RESEARCH.md
@.planning/phases/01-feasible-by-design-nascar-simulation-core/01-feasible-by-design-nascar-simulation-core-VERIFICATION.md
@/Users/zax/Desktop/nascar-model copy 2/.planning/phases/01-feasible-by-design-nascar-simulation-core/01-03-PLAN.md
@/Users/zax/Desktop/nascar-model copy 2/.planning/phases/01-feasible-by-design-nascar-simulation-core/01-05-PLAN.md
@/Users/zax/Desktop/nascar-model copy 2/packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py

# Gap being closed:
Gap 2 from verification report: "CBN not integrated into scenario generation - scenario_generator.py line 416 comment acknowledges 'Full hybrid granularity simulation will be implemented in Phase 2'"

Current implementation uses simplified outcome generation (lines 422-459) instead of calling CBN.sample_outcomes().

# Prior plan context:
01-03-PLAN.md created SkeletonNarrative with create_mock_cbn and generate_single_scenario, but CBN integration was deferred.
01-05-PLAN.md implements real CBN sampling (completes the dependency).

# Research decisions from 01-RESEARCH.md:
- Hybrid granularity: Fine for key segments (cautions, pit cycles, late race)
- CBN conditioning: Use race-flow regime as evidence (e.g., caution_count influences outcome distributions)
- Feasible-by-design: Dirichlet sampling for conservation already working, don't break it
</context>

<tasks>

<task type="auto">
  <name>Replace simplified outcome generation with CBN-conditioned sampling</name>
  <files>packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py</files>
  <action>
    In `SkeletonNarrative.generate_single_scenario()` method, replace simplified outcome generation (around lines 422-459) with CBN-conditioned sampling:

    1. **Build evidence dict from race-flow regime**:
       ```python
       # Build evidence for CBN conditioning
       evidence = {
           f"{driver_id}_skill": driver_skill,  # From ontology priors
           "n_cautions": regime.n_cautions,
           "pit_strategy": regime.pit_strategy.value,
           "fuel_window_risk": regime.fuel_window_risk,
           "late_race_chaos": regime.late_race_chaos,
       }
       ```

    2. **Call CBN sampling** (replace simplified logic):
       ```python
       # Sample driver outcomes from CBN conditioned on regime
       all_outcomes = self.cbn.sample_outcomes(
           n_samples=len(self.driver_ids),
           evidence=evidence
       )
       ```

    3. **Extract driver-specific outcomes**:
       For each driver_id in self.driver_ids:
       - Extract from sampled DataFrame:
         - laps_led = all_outcomes[f"{driver_id}_laps_led"].iloc[driver_idx]
         - fastest_laps = all_outcomes[f"{driver_id}_fastest_laps"].iloc[driver_idx]
         - finish_position = all_outcomes[f"{driver_id}_finish_position"].iloc[driver_idx]
         - incident = all_outcomes[f"{driver_id}_incident"].iloc[driver_idx]
       - Populate DriverOutcome dataclass

    4. **Handle CBN sampling failures gracefully**:
       - If CBN sampling returns empty DataFrame (evidence inconsistency):
         - Log warning
         - Fall back to simplified outcome generation (keep old code as fallback)
       - If CBN not initialized (self.cbn is None):
         - Use simplified outcome generation

    5. **Remove deferred implementation comment**:
       - Delete or update comment on line 416: "Full hybrid granularity simulation will be implemented in Phase 2"
       - Replace with: "CBN-conditioned outcome sampling for hybrid granularity simulation"

    6. **Preserve conservation enforcement**:
       - Keep existing Dirichlet sampling code for laps_led and fastest_laps
       - Use CBN samples as priors for Dirichlet distribution:
         ```python
         # Use CBN-sampled laps_led as concentration parameters
         cbn_laps_led = [...]  # From CBN
         alpha = jnp.array(cbn_laps_led) + 1.0  # Add smoothing
         proportions = jax.random.dirichlet(key, alpha)
         final_laps_led = (proportions * self.race_length).astype(int)
         ```
       - This ensures CBN-informed outcomes while maintaining conservation

    7. **Update logging**:
       - Log evidence conditioning: `logger.info(f"Sampling outcomes for {len(driver_ids)} drivers with evidence: {evidence}")`
       - Log CBN sampling results: `logger.debug(f"CBN sampled outcomes shape: {all_outcomes.shape}")`

    Keep imports from prior plans:
    - `from packages.axiomatic_sim.src.cbn import CausalBayesianNetwork`
    - `from packages.axiomatic_sim.src.narrative import DriverOutcome`

    DO NOT: Break kernel conservation validation (must still work). DO NOT: Remove Dirichlet sampling (it ensures conservation). DO NOT: Change method signature.
  </action>
  <verify>
    Run: `python -c "
from packages.axiomatic_sim.src.scenario_generator import SkeletonNarrative, create_mock_cbn
from packages.axiomatic_sim.src.ontology_constraints import OntologyConstraints
print('Scenario generator imports successfully')
print('SkeletonNarrative has generate_single_scenario method')
"
    `
  </verify>
  <done>
    Simplified outcome generation replaced with CBN.sample_outcomes() call, evidence dict built from race-flow regime, driver outcomes extracted from CBN samples, conservation enforcement preserved via Dirichlet sampling, deferred implementation comment removed
  </done>
</task>

<task type="auto">
  <name>Create integration tests verifying CBN sampling in scenario generation</name>
  <files>packages/axiomatic-sim/tests/test_scenario_generator_integration.py</files>
  <action>
    Create `packages/axiomatic-sim/tests/test_scenario_generator_integration.py` with:

    1. **test_cbn_sample_outcomes_called**:
       - Given: SkeletonNarrative with mock CBN
       - When: Generate 10 scenarios
       - Then: CBN.sample_outcomes called for each scenario
       - Verify: Mock call count >= 10 (may be more due to re-sampling for conservation)

    2. **test_cbn_evidence_conditioning_works**:
       - Given: SkeletonNarrative with mock CBN that tracks evidence
       - When: Generate scenario with high-caution regime (n_cautions=8)
       - Then: CBN.sample_outcomes called with evidence containing n_cautions=8
       - Verify: Mock CBN received correct evidence dict

    3. **test_causal_outcomes_reflected_in_scenarios**:
       - Given: Mock CBN where high skill → high laps_led
       - When: Generate scenarios with high-skill drivers
       - Then: High-skill drivers lead more laps on average than low-skill drivers
       - Verify: mean_laps_led(high_skill) > mean_laps_led(low_skill)

    4. **test_conservation_still_works_with_cbn**:
       - Given: SkeletonNarrative with CBN and kernel
       - When: Generate 100 scenarios
       - Then: All scenarios pass kernel conservation validation
       - Verify: All scenarios have conservation_metadata.validation_passed == True

    5. **test_fallback_to_simplified_if_cbn_fails**:
       - Given: SkeletonNarrative with CBN that raises exception
       - When: Generate scenario
       - Then: Falls back to simplified outcome generation
       - Verify: Scenario still generated, no exception raised

    Use pytest fixtures:
    - `@pytest.fixture` for mock_cbn_with_tracking (tracks calls and evidence)
    - `@pytest.fixture` for skeleton_narrative_with_cbn
    - Mock kernel to always return valid ConservationResult

    Mock CBN behavior:
    - Return deterministic samples based on evidence
    - Track call count and evidence for verification
    - Optionally raise exception to test fallback

    Run with: `pytest packages/axiomatic-sim/tests/test_scenario_generator_integration.py -v`

    DO NOT: Duplicate tests from test_scenario_generator.py (those test general generation). DO NOT: Test CBN sampling itself (covered in test_cbn_sampling.py).
  </action>
  <verify>
    Run: `pytest packages/axiomatic-sim/tests/test_scenario_generator_integration.py -v`
    Verify all 5 tests pass
  </verify>
  <done>
    All 5 tests pass, CBN.sample_outcomes called during scenario generation, evidence conditioning verified, causal outcomes reflected in scenarios, conservation validation still works, fallback to simplified generation works
  </done>
</task>

</tasks>

<verification>
Run integration test: `pytest packages/axiomatic-sim/tests/test_scenario_generator_integration.py -v`

End-to-end verification: Generate scenarios with CBN sampling and verify causal outcomes:
```bash
python -c "
from packages.axiomatic_sim.src.scenario_generator import generate_scenarios, create_mock_cbn
from packages.axiomatic_sim.src.ontology_constraints import OntologyConstraints
from apps.backend.app.kernel import KernelLogic
import pandas as pd

# Create CBN and generator
ontology = OntologyConstraints()
cbn = create_mock_cbn(ontology, ['driver_1', 'driver_2', 'driver_3'])
kernel = KernelLogic(field_size=40)

# Generate scenarios
scenarios = generate_scenarios('test_track', n_scenarios=10, ontology=None, kernel=kernel, cbn=cbn)
print(f'Generated {len(scenarios)} scenarios with CBN sampling')

# Check that CBN was used (outcomes should vary based on skill)
driver_1_laps = [s.driver_outcomes['driver_1'].laps_led for s in scenarios]
print(f'Driver 1 laps led variance: {pd.Series(driver_1_laps).var()}')

# Verify conservation still works
all_valid = all(s.conservation_metadata.validation_passed for s in scenarios)
print(f'All scenarios passed conservation validation: {all_valid}')
"
```

Check that simplified generation comment removed:
```bash
grep -n "will be implemented in Phase 2" packages/axiomatic-sim/src/axiomatic_sim/scenario_generator.py
# Should return nothing (comment removed or updated)
```
</verification>

<success_criteria>
1. CBN.sample_outcomes() called in generate_single_scenario with evidence from race-flow regime
2. Simplified outcome generation replaced (lines 422-459 refactored to use CBN samples)
3. Evidence dict includes regime variables (n_cautions, pit_strategy, fuel_window_risk)
4. Driver outcomes extracted from CBN samples and used in DriverOutcome creation
5. Conservation enforcement preserved (Dirichlet sampling uses CBN samples as priors)
6. Kernel validation still passes all scenarios
7. Tests verify CBN sampling integration and causal outcome effects
8. Deferred implementation comment removed or updated
</success_criteria>

<output>
After completion, create `.planning/phases/01-feasible-by-design-nascar-simulation-core/01-06-SUMMARY.md`
</output>
