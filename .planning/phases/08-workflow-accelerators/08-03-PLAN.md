---
phase: 08-workflow-accelerators
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/native_mac/shortcuts/shortcut_manager.py
  - apps/native_mac/gui/mainwindow.py
  - apps/native_mac/main.py
autonomous: true

must_haves:
  truths:
    - "User can perform common actions via keyboard shortcuts (no mouse required)"
    - "Shortcuts follow standard macOS conventions (CMD+letter)"
    - "Shortcuts work globally across all tabs (ApplicationShortcut context)"
    - "All major actions have shortcuts: new, open, save, optimize, undo, redo, focus panes"
    - "Shortcuts are customizable via preferences dialog"
  artifacts:
    - path: "apps/native_mac/shortcuts/shortcut_manager.py"
      provides: "ShortcutManager with QAction creation and customization"
      min_lines: 200
    - path: "apps/native_mac/gui/dialogs/shortcut_config_dialog.py"
      provides: "Dialog for customizing keyboard shortcuts"
      min_lines: 150
    - path: "apps/native_mac/main.py"
      provides: "All major actions have QAction with shortcuts"
      contains: "QKeySequence.New, QKeySequence.Open, etc."
  key_links:
    - from: "ShortcutManager"
      to: "QSettings"
      via: "Custom shortcut persistence"
    - from: "MainWindow"
      to: "ShortcutManager"
      via: "create_action() for all menu/toolbar actions"
    - from: "ShortcutConfigDialog"
      to: "ShortcutManager"
      via: "set_custom_shortcut() and conflict detection"
---

<objective>
Implement comprehensive keyboard shortcut system enabling full keyboard-driven workflow with standard macOS conventions and customization support.

Purpose: Power users want keyboard-driven workflows to avoid mouse context-switching. This differentiates from web-based optimizers that require mouse interaction.

Output: ShortcutManager class, ShortcutConfigDialog for customization, all major actions have shortcuts, persisted to QSettings
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-accelerators/08-CONTEXT.md
@.planning/phases/08-workflow-accelerators/08-RESEARCH.md
@apps/native_mac/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShortcutManager with QAction factory</name>
  <files>apps/native_mac/shortcuts/shortcut_manager.py</files>
  <action>
    Create ShortcutManager class that manages customizable keyboard shortcuts using QAction and QKeySequence.

    Default shortcuts (standard macOS conventions):
    - new_race: QKeySequence.New (Cmd+N)
    - open_data: QKeySequence.Open (Cmd+O)
    - save_lineups: QKeySequence.Save (Cmd+S)
    - undo: QKeySequence.Undo (Cmd+Z)
    - redo: QKeySequence.Redo (Cmd+Shift+Z)
    - optimize: QKeySequence("Ctrl+Return") (Cmd+Return on Mac)
    - cancel: QKeySequence.Cancel (Cmd+.)
    - preferences: QKeySequence.Preferences (Cmd+,)
    - quit: QKeySequence.Quit (Cmd+Q)
    - toggle_split: QKeySequence("Ctrl+\\") (toggle split-pane)
    - focus_constraints: QKeySequence("Ctrl+1") (focus left pane)
    - focus_preview: QKeySequence("Ctrl+2") (focus right pane)
    - focus_logs: QKeySequence("Ctrl+3") (focus veto logs)
    - apply_preset: QKeySequence("Ctrl+P") (apply constraint preset)
    - save_preset: QKeySequence("Ctrl+Shift+P") (save current as preset)
    - next_tab: QKeySequence("Ctrl+Tab") (next tab)
    - prev_tab: QKeySequence("Ctrl+Shift+Tab") (previous tab)
    - find: QKeySequence.Find (Cmd+F)
    - export_csv: QKeySequence("Ctrl+E") (export to DraftKings)
    - show_jobs: QKeySequence("Ctrl+J") (switch to Jobs tab)
    - show_lineups: QKeySequence("Ctrl+L") (switch to Lineups tab)

    Methods:
    - create_action(action_id: str, text: str, callback, icon=None, parent=None) -> QAction: Create action with shortcut
    - set_custom_shortcut(action_id: str, key_sequence: QKeySequence) -> None: Update shortcut
    - reset_to_defaults() -> None: Restore all default shortcuts
    - check_conflicts(key_sequence: QKeySequence) -> List[str]: Return action_ids using this shortcut
    - get_shortcut(action_id: str) -> QKeySequence: Get current shortcut
    - export_shortcuts(filepath: str) -> None: Export to JSON
    - import_shortcuts(filepath: str) -> None: Import from JSON

    Persistence:
    - Load custom shortcuts from QSettings on init
    - Save custom shortcuts to QSettings when changed

    Use Qt.ApplicationShortcut context for global shortcuts.
    Store action_id -> QAction mapping in self.actions dict.
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication, QWidget
    from PySide6.QtGui import QKeySequence
    app = QApplication.instance() or QApplication([])
    from apps.native_mac.shortcuts.shortcut_manager import ShortcutManager
    sm = ShortcutManager()
    parent = QWidget()
    action = sm.create_action('test', 'Test', lambda: None, parent=parent)
    print(f'Action created: {action.text()}, shortcut: {action.shortcut().toString()}')
    # Test conflict detection
    conflicts = sm.check_conflicts(QKeySequence.New)
    print(f'Conflicts check OK')
    print('ShortcutManager OK')
    "
  </verify>
  <done>ShortcutManager exists with all default shortcuts, create_action() working, conflict detection functional</done>
</task>

<task type="auto">
  <name>Task 2: Create ShortcutConfigDialog for customization</name>
  <files>apps/native_mac/gui/dialogs/shortcut_config_dialog.py</files>
  <action>
    Create ShortcutConfigDialog for users to view and customize keyboard shortcuts.

    UI layout:
    - QListWidget showing all actions with current shortcuts (e.g., "New Race: Cmd+N")
    - Click or double-click on item opens key capture dialog
    - QKeySequenceEdit widget for capturing new shortcuts
    - Conflict warning label (red text) when selected shortcut conflicts
    - "Reset to Defaults" button
    - "OK" / "Cancel" buttons

    Features:
    - Real-time conflict detection when typing new shortcut
    - Show conflicting action names in warning label
    - Prevent setting shortcut that conflicts (or warn and allow override)
    - Group actions by category (File, Edit, View, Optimization, Navigation)

    Implementation:
    - Accept ShortcutManager in constructor
    - Populate list from shortcut_manager.actions
    - On shortcut change: call shortcut_manager.set_custom_shortcut()
    - On reset: call shortcut_manager.reset_to_defaults() and refresh list

    Styling:
    - Follow macOS preferences dialog style
    - Use QDialogButtonBox for standard buttons
    - Minimum size 500x400 for readability
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication
    app = QApplication.instance() or QApplication([])
    from apps.native_mac.shortcuts.shortcut_manager import ShortcutManager
    from apps.native_mac.gui.dialogs.shortcut_config_dialog import ShortcutConfigDialog
    sm = ShortcutManager()
    # Create parent widget
    from PySide6.QtWidgets import QWidget
    parent = QWidget()
    dialog = ShortcutConfigDialog(sm, parent)
    print(f'Dialog created: {dialog.windowTitle()}')
    print('ShortcutConfigDialog OK')
    "
  </verify>
  <done>ShortcutConfigDialog exists with list view, conflict detection, and customization support</done>
</task>

<task type="auto">
  <name>Task 3: Integrate shortcuts into MainWindow and all menus</name>
  <files>
    apps/native_mac/main.py
    apps/native_mac/gui/mainwindow.py
  </files>
  <action>
    Integrate ShortcutManager throughout the application menus and actions.

    In main.py / MainWindow:
    - Create ShortcutManager instance alongside other managers
    - Replace all QAction creation with shortcut_manager.create_action()

    Update menus to use ShortcutManager:
    - File menu: new_race, open_data, save_lineups, export_csv, quit
    - Edit menu: undo, redo, preferences (managed by UndoManager + ShortcutManager)
    - View menu: toggle_split, focus_constraints, focus_preview, focus_logs
    - Optimize menu: optimize, cancel, apply_preset, save_preset
    - Navigate menu: next_tab, prev_tab, show_jobs, show_lineups

    Add menu action:
    - View > Customize Shortcuts... (opens ShortcutConfigDialog)

    Ensure shortcuts work across all tabs:
    - Use Qt.ApplicationShortcut context (automatic via ShortcutManager)
    - Shortcuts should work even when focus is in text fields

    Test key shortcuts:
    1. Press Cmd+O → should trigger file open
    2. Press Cmd+Return → should trigger optimization
    3. Press Ctrl+1 → should focus constraints panel
    4. Press Cmd+Tab → should switch to next tab

    Update settings_tab.py:
    - Add "Keyboard Shortcuts" section with button to open ShortcutConfigDialog
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication
    app = QApplication.instance() or QApplication([])
    from PySide6.QtGui import QKeySequence
    from apps.native_mac.shortcuts.shortcut_manager import ShortcutManager
    sm = ShortcutManager()
    # Verify all expected shortcuts exist
    expected = ['new_race', 'open_data', 'save_lineups', 'undo', 'redo', 'optimize', 
                'toggle_split', 'focus_constraints', 'focus_preview', 'apply_preset']
    for action_id in expected:
        shortcut = sm.get_shortcut(action_id)
        print(f'{action_id}: {shortcut.toString() if shortcut else \"None\"}')
    print('All shortcuts defined OK')
    "
  </verify>
  <done>All menu actions use ShortcutManager, shortcuts active in all tabs, Customize Shortcuts dialog accessible</done>
</task>

</tasks>

<verification>
- [ ] ShortcutManager creates QAction with QKeySequence for all major actions
- [ ] Standard shortcuts work: Cmd+O (open), Cmd+S (save), Cmd+Return (optimize)
- [ ] Navigation shortcuts work: Ctrl+Tab (next tab), Ctrl+1/2/3 (focus panes)
- [ ] ShortcutConfigDialog opens and allows customization
- [ ] Conflict detection warns when duplicate shortcut assigned
- [ ] Custom shortcuts persist across app restarts via QSettings
- [ ] Reset to Defaults restores original shortcut assignments
</verification>

<success_criteria>
1. User opens file with Cmd+O without touching mouse
2. User triggers optimization with Cmd+Return
3. User switches tabs with Ctrl+Tab
4. User opens ShortcutConfigDialog and changes a shortcut
5. Changed shortcut persists after app restart
6. All major actions have keyboard shortcuts listed in menus
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-accelerators/08-03-SUMMARY.md`
</output>
