---
phase: 08-workflow-accelerators
plan: 06
type: execute
wave: 3
depends_on:
  - 08-01
  - 08-02
  - 08-04
files_modified:
  - apps/native_mac/export/backup_manager.py
  - apps/native_mac/gui/dialogs/export_dialog.py
  - apps/native_mac/gui/views/settings_tab.py
  - apps/native_mac/main.py
autonomous: true

must_haves:
  truths:
    - "User can export all settings, presets, lineups, and races to a single JSON file"
    - "User can import previously exported backup file to restore state"
    - "Export includes constraint presets with full configuration"
    - "Export includes all saved lineups with driver assignments"
    - "User can select what to export (settings only, lineups only, or everything)"
  artifacts:
    - path: "apps/native_mac/export/backup_manager.py"
      provides: "BackupManager for import/export operations"
      min_lines: 200
    - path: "apps/native_mac/gui/dialogs/export_dialog.py"
      provides: "ExportDialog for configuring what to export"
      min_lines: 150
    - path: "apps/native_mac/gui/views/settings_tab.py"
      provides: "Backup section with export/import buttons"
      contains: "Backup/Export section with Export All and Import buttons"
  key_links:
    - from: "BackupManager"
      to: "DatabaseManager"
      via: "Query all tables for export data"
    - from: "BackupManager"
      to: "PresetManager"
      via: "Export/import constraint presets"
    - from: "SettingsTab"
      to: "BackupManager"
      via: "export_all(), import_backup() calls"
---

<objective>
Implement comprehensive backup and export system allowing users to save and restore all application state including settings, constraint presets, lineups, and race data.

Purpose: Users need data portability for moving between machines, backup for safety, and sharing configurations with collaborators. JSON format enables human-readable exports and version control.

Output: BackupManager class, ExportDialog UI, SettingsTab integration for one-click backup/restore
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-accelerators/08-CONTEXT.md
@.planning/phases/08-workflow-accelerators/08-RESEARCH.md
@.planning/phases/08-workflow-accelerators/08-01-SUMMARY.md
@.planning/phases/08-workflow-accelerators/08-02-SUMMARY.md
@.planning/phases/08-workflow-accelerators/08-04-SUMMARY.md
@apps/native_mac/persistence/database.py
@apps/native_mac/gui/views/settings_tab.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BackupManager for export/import operations</name>
  <files>apps/native_mac/export/backup_manager.py</files>
  <action>
    Create BackupManager class that handles comprehensive export and import of application state.

    Export format (JSON structure):
    ```json
    {
      "export_metadata": {
        "version": "1.2",
        "export_date": "2026-01-30T12:00:00Z",
        "app_version": "1.2.0",
        "includes": ["settings", "presets", "lineups", "races", "jobs"]
      },
      "settings": {
        "window_geometry": "base64_encoded",
        "theme": "dark",
        "restore_session": true,
        "debounce_ms": 300,
        "real_time_mode": false,
        "shortcuts": {...}
      },
      "constraint_presets": [
        {"id": 1, "name": "Conservative", "is_global": true, "config": {...}}
      ],
      "recent_presets": [1, 3, 5],
      "races": [
        {"id": 1, "track_name": "Daytona", "race_date": "2026-02-15", "drivers": [...]}
      ],
      "lineups": [
        {"id": 1, "race_id": 1, "drivers": [...], "created_at": "..."}
      ],
      "jobs": [
        {"id": "uuid", "name": "Daytona Opt", "config": {...}, "results": {...}}
      ],
      "veto_logs": [...]
    }
    ```

    Methods:
    - export_all(filepath: str, options: Dict) -> bool: Export everything to JSON
    - export_settings(filepath: str) -> bool: Export only settings
    - export_presets(filepath: str) -> bool: Export only presets
    - export_lineups(filepath: str, race_id: Optional[int] = None) -> bool: Export lineups (optionally filtered by race)
    - import_backup(filepath: str, options: Dict) -> bool: Import from JSON with merge/replace options
    - validate_backup(filepath: str) -> Tuple[bool, List[str]]: Validate backup format and version

    Export options:
    - include_settings: bool (default True)
    - include_presets: bool (default True)
    - include_lineups: bool (default True)
    - include_races: bool (default True)
    - include_jobs: bool (default False - can be large)
    - include_veto_logs: bool (default False)
    - date_range: Optional[Tuple[date, date]] - Filter by date

    Import options:
    - merge_strategy: "replace" | "merge" | "skip_existing"
    - target_race_id: Optional[int] - Import lineups for specific race only

    Data gathering:
    - Query all tables from DatabaseManager
    - Use PresetManager for constraint presets
    - Use QSettings for app settings
    - Handle binary data (window geometry) via base64 encoding

    Error handling:
    - Try/except around all file operations
    - JSON validation with jsonschema (optional) or manual checks
    - Return (success, message) tuple for UI feedback
  </action>
  <verify>
    python -c "
    import json
    import tempfile
    from apps.native_mac.export.backup_manager import BackupManager
    from apps.native_mac.persistence.database import DatabaseManager
    from apps.native_mac.persistence.preset_manager import PresetManager
    
    db = DatabaseManager('test_backup.db')
    pm = PresetManager('test_backup.db')
    bm = BackupManager(db, pm)
    
    # Test export
    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
        temp_path = f.name
    
    success = bm.export_all(temp_path, {'include_settings': True, 'include_presets': True})
    print(f'Export success: {success}')
    
    # Verify JSON structure
    with open(temp_path, 'r') as f:
        data = json.load(f)
    assert 'export_metadata' in data
    print('BackupManager export OK')
    
    # Cleanup
    import os
    os.unlink(temp_path)
    print('BackupManager OK')
    "
  </verify>
  <done>BackupManager exists with export_all() and import_backup() methods, JSON format defined</done>
</task>

<task type="auto">
  <name>Task 2: Create ExportDialog for selective export configuration</name>
  <files>apps/native_mac/gui/dialogs/export_dialog.py</files>
  <action>
    Create ExportDialog for users to configure what data to export.

    UI layout:
    - Header: "Export Application Data" with description text
    - Checkboxes for what to include:
      - [x] Application Settings (window geometry, preferences, shortcuts)
      - [x] Constraint Presets (all saved presets and recent history)
      - [x] Saved Lineups (all generated lineups)
      - [x] Race Data (imported driver data and races)
      - [ ] Job History (optimization job configs and results - can be large)
      - [ ] Veto Logs (kernel rejection logs)
    - Date range filter (optional):
      - [ ] Only include data from last [30] days
      - From date picker / To date picker
    - Export destination:
      - Path display with Browse button
      - Default filename: "nascar_optimizer_backup_2026-01-30.json"
    - Format option:
      - JSON (human-readable, recommended)
      - Compressed JSON (smaller file)
    - Buttons:
      - Export (primary action)
      - Cancel

    Validation:
    - At least one checkbox must be selected
    - Valid filepath must be specified
    - Warn if file already exists (overwrite confirmation)

    Result:
    - Dialog returns (accepted, options_dict) when accepted
    - options_dict contains all selected checkboxes and filters

    Styling:
    - Follow macOS dialog conventions
    - Use QDialogButtonBox for standard buttons
    - Group related options with QGroupBox
    - Minimum size 500x500
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication
    app = QApplication.instance() or QApplication([])
    from apps.native_mac.gui.dialogs.export_dialog import ExportDialog
    from PySide6.QtWidgets import QWidget
    parent = QWidget()
    dialog = ExportDialog(parent)
    print(f'ExportDialog created: {dialog.windowTitle()}')
    # Check UI elements exist
    assert hasattr(dialog, 'settings_checkbox')
    assert hasattr(dialog, 'presets_checkbox')
    assert hasattr(dialog, 'lineups_checkbox')
    print('ExportDialog UI OK')
    print('ExportDialog OK')
    "
  </verify>
  <done>ExportDialog exists with checkboxes for all data types, date filters, and file selection</done>
</task>

<task type="auto">
  <name>Task 3: Integrate backup/export into SettingsTab and MainWindow</name>
  <files>
    apps/native_mac/gui/views/settings_tab.py
    apps/native_mac/main.py
    apps/native_mac/gui/mainwindow.py
  </files>
  <action>
    Integrate backup/export functionality into the Settings UI and wire to BackupManager.

    In settings_tab.py:
    - Add new section "Backup & Export" (below existing sections)
    - Section contents:
      - Description label: "Export all your data for backup or transfer to another machine"
      - "Export All Data..." button - opens ExportDialog, calls BackupManager.export_all()
      - "Export Lineups Only..." button - quick export just lineups
      - "Import Backup..." button - opens file dialog, calls BackupManager.import_backup()
      - "Export Presets..." button - for sharing presets
    - Show last backup date if available (store in QSettings)
    - Progress indicator during export/import (large exports can take time)

    In main.py:
    - Create BackupManager instance with DatabaseManager and PresetManager
    - Pass BackupManager to SettingsTab
    - Add File menu items:
      - File > Export > All Data...
      - File > Export > Lineups...
      - File > Export > Presets...
      - File > Import > From Backup...
    - Connect menu actions to BackupManager methods

    Import workflow:
    1. User selects File > Import > From Backup...
    2. File dialog opens (filter: *.json)
    3. Validate backup file (version check, structure check)
    4. Show confirmation dialog with what's included in backup
    5. Ask merge strategy: "Replace all" or "Merge with existing"
    6. Perform import with progress dialog
    7. Show success/failure message
    8. Refresh UI (reload races, presets, lineups)

    Safety features:
    - Create automatic backup before import (export current state to .bak)
    - Transactional import: Rollback on error (use SQLite transactions)
    - Validation: Check version compatibility (warn if backup from newer app version)

    Keyboard shortcuts:
    - Cmd+Shift+E: Export All Data
    - Cmd+Shift+I: Import Backup
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication
    app = QApplication.instance() or QApplication([])
    from apps.native_mac.export.backup_manager import BackupManager
    from apps.native_mac.gui.views.settings_tab import SettingsTab
    from apps.native_mac.persistence.database import DatabaseManager
    from apps.native_mac.persistence.preset_manager import PresetManager
    
    db = DatabaseManager('test_settings_int.db')
    pm = PresetManager('test_settings_int.db')
    bm = BackupManager(db, pm)
    
    # Verify integration points
    print(f'BackupManager: {bm}')
    print('SettingsTab import OK')
    print('Integration OK')
    "
  </verify>
  <done>SettingsTab has Backup section with export/import buttons, File menu has export/import actions, shortcuts active</done>
</task>

</tasks>

<verification>
- [ ] BackupManager can export all data types to JSON
- [ ] BackupManager can import JSON and restore state
- [ ] ExportDialog allows selecting what to export
- [ ] SettingsTab shows Backup section with export/import buttons
- [ ] File menu has Export and Import submenus
- [ ] Export includes proper metadata (version, date, app version)
- [ ] Import validates backup format before processing
- [ ] Automatic backup created before import (safety feature)
</verification>

<success_criteria>
1. User clicks "Export All Data" and gets JSON file with settings, presets, lineups, and races
2. User opens JSON file and sees human-readable structure
3. User clicks "Import Backup" and selects previously exported file
4. App restores all data from backup with confirmation dialog
5. User exports only presets to share with collaborator
6. Backup file survives app version upgrade (format compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-accelerators/08-06-SUMMARY.md`
</output>
