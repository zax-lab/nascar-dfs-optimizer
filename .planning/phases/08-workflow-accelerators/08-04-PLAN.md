---
phase: 08-workflow-accelerators
plan: 04
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - apps/native_mac/gui/views/split_editor_tab.py
  - apps/native_mac/gui/widgets/constraint_panel.py
  - apps/native_mac/gui/widgets/live_preview.py
  - apps/native_mac/jobs/job_manager.py
autonomous: true

must_haves:
  truths:
    - "User can drag splitter to resize constraint panel and live preview panes"
    - "Constraint changes trigger debounced optimization (300ms default)"
    - "Live preview pane shows updated lineups after optimization completes"
    - "Splitter state persists across app restarts"
    - "User can toggle real-time vs debounced mode in settings"
  artifacts:
    - path: "apps/native_mac/gui/views/split_editor_tab.py"
      provides: "SplitEditorTab with QSplitter layout"
      min_lines: 300
    - path: "apps/native_mac/gui/widgets/live_preview.py"
      provides: "LivePreview widget showing lineup table"
      min_lines: 150
    - path: "apps/native_mac/jobs/job_manager.py"
      provides: "Debounce timer integration for constraint changes"
      contains: "QTimer.singleShot() restart pattern"
  key_links:
    - from: "ConstraintPanel"
      to: "SplitEditorTab"
      via: "constraints_changed signal -> debounce timer"
    - from: "SplitEditorTab"
      to: "JobManager"
      via: "submit_job() after debounce timeout"
    - from: "JobManager"
      to: "LivePreview"
      via: "job_completed signal -> lineup display update"
    - from: "QSplitter"
      to: "QSettings"
      via: "saveState()/restoreState() for persistence"
---

<objective>
Implement split-view editor with draggable panes and debounced live optimization, providing iTerm/VSCode-style layout with real-time lineup preview updates.

Purpose: Power users need to see lineup results immediately as they adjust constraints, enabling rapid iteration without manual re-optimization clicks.

Output: SplitEditorTab with QSplitter layout, LivePreview widget, debounced optimization trigger, splitter state persistence
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-accelerators/08-CONTEXT.md
@.planning/phases/08-workflow-accelerators/08-RESEARCH.md
@.planning/phases/08-workflow-accelerators/08-01-SUMMARY.md
@apps/native_mac/gui/widgets/constraint_panel.py
@apps/native_mac/jobs/job_manager.py
@apps/native_mac/gui/views/optimization_tab.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SplitEditorTab with QSplitter layout</name>
  <files>apps/native_mac/gui/views/split_editor_tab.py</files>
  <action>
    Create SplitEditorTab that replaces or supplements the standard OptimizationTab with a split-pane layout.

    Layout structure (follow research Pattern 1):
    - Main horizontal QSplitter (left/right panes)
    - Left pane: ConstraintPanel (existing widget)
    - Right pane: QSplitter (vertical) containing:
      - Top: LivePreview widget (lineup results table)
      - Bottom: Collapsible veto log viewer placeholder

    Implementation:
    - Inherit from QWidget (not QTabWidget)
    - Create main_splitter = QSplitter(Qt.Horizontal)
    - Create right_splitter = QSplitter(Qt.Vertical) for right side
    - Use setStretchFactor() to give more space to right pane (2:1 ratio)
    - Set minimum sizes to prevent collapsing (200px min for each pane)
    - Handle splitterMoved signal to save state

    State persistence:
    - Use QSettings (not base64 JSON) for binary state
    - Save on splitterMoved (debounced with 500ms timer)
    - Restore in __init__ before showing
    - Key: "split_editor/main_splitter_state" and "split_editor/right_splitter_state"

    Navigation integration:
    - Connect focus_constraints shortcut to left pane focus
    - Connect focus_preview shortcut to LivePreview focus
    - Connect focus_logs shortcut to veto log pane focus

    Add toggle action:
    - View menu: "Toggle Split View" (Ctrl+\)
    - When toggled, collapse/expand one pane (or switch between tab and split view)

    Follow patterns from optimization_tab.py for layout and styling.
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication
    app = QApplication.instance() or QApplication([])
    from apps.native_mac.gui.views.split_editor_tab import SplitEditorTab
    from apps.native_mac.persistence.database import DatabaseManager
    from apps.native_mac.optimization.engine import OptimizationEngine
    db = DatabaseManager('test_split.db')
    engine = OptimizationEngine(db)
    tab = SplitEditorTab(db, engine, parent=None)
    print(f'SplitEditorTab created: {tab}')
    print(f'Has splitter: {tab.main_splitter is not None}')
    print('OK')
    "
  </verify>
  <done>SplitEditorTab exists with horizontal splitter, vertical right splitter, persistence setup</done>
</task>

<task type="auto">
  <name>Task 2: Create LivePreview widget and debounce integration</name>
  <files>
    apps/native_mac/gui/widgets/live_preview.py
    apps/native_mac/gui/widgets/constraint_panel.py
    apps/native_mac/gui/views/split_editor_tab.py
  </files>
  <action>
    Create LivePreview widget and implement debounced optimization trigger.

    LivePreview widget (apps/native_mac/gui/widgets/live_preview.py):
    - Display lineup table similar to LineupsTab but compact
    - Use LineupTableModel (already exists from Phase 6)
    - Show top 10 lineups by default (configurable)
    - Color-code top 20% lineups (existing pattern)
    - Status label showing "Waiting...", "Optimizing...", "N lineups ready"
    - Progress indicator (spinner or progress bar)

    Debounce implementation in SplitEditorTab:
    - QTimer with singleShot mode (Pattern 5 from research)
    - Default delay: 300ms (configurable via Settings)
    - Restart timer on every constraint change (stop then start)
    - When timer fires: submit job to JobManager
    - Toggle for real-time mode (no debounce, trigger immediately)

    Constraint change flow:
    1. User changes constraint in ConstraintPanel
    2. ConstraintPanel emits constraints_changed signal
    3. SplitEditorTab receives signal, restarts debounce timer
    4. After 300ms of no changes, timer triggers
    5. SplitEditorTab submits optimization job to JobManager
    6. LivePreview shows "Optimizing..." status
    7. On job_completed, LivePreview displays new lineups

    Settings integration:
    - Add "Live Optimization" section in SettingsTab
    - Checkbox: "Enable live optimization on constraint changes"
    - SpinBox: "Debounce delay (ms)" (100-2000, default 300)
    - Checkbox: "Real-time mode (no debounce)"

    Prevent duplicate jobs:
    - Track pending_job_id in SplitEditorTab
    - Cancel pending job if new constraint change arrives before completion
    - Use JobManager.cancel_job() if available
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication
    from PySide6.QtCore import QTimer
    app = QApplication.instance() or QApplication([])
    from apps.native_mac.gui.widgets.live_preview import LivePreview
    preview = LivePreview()
    print(f'LivePreview created: {preview}')
    # Test debounce timer pattern
    timer = QTimer()
    timer.setSingleShot(True)
    timer.start(100)
    print('Debounce timer OK')
    print('OK')
    "
  </verify>
  <done>LivePreview widget exists, debounce timer implemented in SplitEditorTab, settings integration complete</done>
</task>

<task type="auto">
  <name>Task 3: Wire debounced optimization with JobManager and PresetManager</name>
  <files>
    apps/native_mac/gui/views/split_editor_tab.py
    apps/native_mac/jobs/job_manager.py
    apps/native_mac/persistence/preset_manager.py
    apps/native_mac/main.py
  </files>
  <action>
    Integrate split editor with existing JobManager and PresetManager for end-to-end workflow.

    SplitEditorTab integration:
    - Accept JobManager via constructor or setter
    - Accept PresetManager for loading presets into constraints
    - Connect JobManager signals:
      - job_started: Update LivePreview status to "Optimizing..."
      - job_progress: Update progress indicator (if JobManager emits progress)
      - job_completed: Update LivePreview with results, emit lineups_generated
      - job_failed: Show error status in LivePreview
      - job_cancelled: Show "Cancelled" status

    Preset integration:
    - Add preset selector dropdown in left pane (above ConstraintPanel)
    - Load preset: calls PresetManager.load_preset() + ConstraintPanel.set_constraints()
    - When preset loaded: Trigger debounced optimization automatically
    - Quick-apply recent presets as buttons

    Job submission logic:
    - Build job config from ConstraintPanel.get_constraints()
    - Include race_id from race selector
    - Use current_drivers (passed from MainWindow or loaded from DB)
    - Honor GPU offload checkbox (pass through to config)
    - Generate job name: "{Track} Live Optimization"

    Race selector:
    - Add race dropdown to top of left pane
    - When race changes: Load saved constraints for that race if any
    - Update preset list based on race type/track

    MainWindow integration:
    - Add "Split Editor" tab to QTabWidget (between Optimization and Jobs)
    - Or replace OptimizationTab entirely (decide based on user workflow)
    - Pass JobManager, DatabaseManager, PresetManager to SplitEditorTab
    - Wire lineups_generated signal to LineupsTab for population

    Test complete flow:
    1. Select race in SplitEditorTab
    2. Adjust salary cap slider
    3. Wait 300ms
    4. See job submitted and status update
    5. See lineups appear in LivePreview when complete
  </action>
  <verify>
    python -c "
    from PySide6.QtWidgets import QApplication
    app = QApplication.instance() or QApplication([])
    from apps.native_mac.gui.views.split_editor_tab import SplitEditorTab
    print('SplitEditorTab import OK')
    # Verify integration points exist
    assert hasattr(SplitEditorTab, 'main_splitter')
    print('Integration check OK')
    "
  </verify>
  <done>SplitEditorTab integrated with JobManager and PresetManager, live optimization flow working end-to-end</done>
</task>

</tasks>

<verification>
- [ ] SplitEditorTab has draggable QSplitter panes (horizontal and vertical)
- [ ] Splitter state saves to QSettings and restores on launch
- [ ] Constraint changes restart debounce timer (300ms default)
- [ ] After debounce, optimization job submits to JobManager
- [ ] LivePreview shows lineup results when job completes
- [ ] Settings allow configuring debounce delay and real-time toggle
- [ ] Keyboard shortcuts (Ctrl+1/2/3) focus different panes
</verification>

<success_criteria>
1. User drags splitter to resize constraint and preview panes
2. User changes salary cap and sees debounced optimization trigger after 300ms
3. Live preview updates with new lineups automatically
4. Splitter positions persist after app restart
5. User toggles real-time mode in settings for immediate optimization
6. Preset changes trigger live optimization automatically
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-accelerators/08-04-SUMMARY.md`
</output>
